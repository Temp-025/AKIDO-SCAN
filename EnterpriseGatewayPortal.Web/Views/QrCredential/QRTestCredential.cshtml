@model EnterpriseGatewayPortal.Web.ViewModel.QrCredential.QrTestCredentialViewModel
@using EnterpriseGatewayPortal.Web.Models;

@{
    ViewData["Title"] = " Credentials New";
    ViewBag.Breadcrumb = new List<BreadCrumbModel>
{
        new BreadCrumbModel { Title = "QR Credential", Url = Url.Action("Index", "QrCredential"),IconKey="QRML"},
        new BreadCrumbModel { Title = "Test Credential", Url = "" ,IconKey = "send"}
    };
}

@{
    await Html.RenderPartialAsync("_AlertBox");
}
<style>
    .file-upload-wrapper {
        max-width: 500px;
        margin-top: 10px;
        text-align: center;
    }

    .upload-label {
        display: inline-block;
        background-color: rgba(249, 247, 237, 0.5);
        border: 1px dashed rgba(155, 158, 148, 1);
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        width: 100%;
        height: 190px;
    }

        .upload-label i {
            margin-right: 8px;
        }

    #jsonFileInput {
        display: none;
    }

    .progress-bar-wrapper {
        width: 100%;
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        display: none;
    }

    .progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(to right, #F3E4BA, #EBD196);
        animation: progressAnim 2s linear forwards;
    }

    @@keyframes progressAnim {
        from {
            width: 0%;
        }

        to {
            width: 100%;
        }
    }

    .upload-message {
        margin-top: 10px;
        font-weight: bold;
        display: none;
        animation: fadeIn 0.5s ease-in-out forwards;
    }

        .upload-message.success {
            color: #28a745;
        }

        .upload-message.error {
            color: #dc3545;
        }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .card {
        padding: 24px;
        border-radius: 16px;
        background-color: #ffffff;
        font-family: Arial, sans-serif;
    }

        .card h3 {
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: #333;
            text-align: center;
        }

    #jsonDataDisplayCard {
        display: none;
        animation: fadeIn 0.5s ease-in-out forwards;
    }

    #uploadCardWrapper {
        display: flex;
        justify-content: center;
        padding: 0px 20px !important;
    }

    .classshide {
        display: none !important;
    }

    .json-input {
        width: 100%;
    }

    .json-validation {
        display: none;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border: 1px solid #E0E0E0;
        border-radius: 8px;
        font-family: "Inter", sans-serif;
    }

        .json-validation .icon-wrapper {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #FFF4E6;
            padding: 8px;
            border-radius: 6px;
        }

    .file-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        flex: 1;
        gap: 6px;
    }

    .file-name {
        font-size: 14px;
        font-weight: 500;
        color: #333;
        word-break: break-word;
    }

    .progress-bar-wrapper {
        width: 100%;
        height: 6px;
        background: #EEE;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #B68A35, #FFD580);
        transition: width 0.3s ease;
    }
</style>
<div class="classshide">
    <div id='viewer'></div>
</div>
<div class="row" id="spacingCss">
    <div class="col-md-12 plr">
        <div>
            <span class="sub-label" style="padding: 0px 0px 0px 24px;color:black;">QR Credential Validation Process</span>
        </div>
        <div class="card-custom" style="padding:20px;">
            <div class="card-body" style="padding:0px !important;">
                <form enctype="multipart/form-data">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <div class="row" id="uploadCardWrapper">
                        <!-- Centered Upload Section -->
                        <div class="col-md-4" id="uploadCard" style="padding:0px !important;max-width:50% !important;">
                            <div class="card" style="margin:0px !important;padding-top:10px !important;">
                                <span style="font-size:14px;font-weight:500;font-family:'Inter';color:black;">Upload JSON File</span>
                                <div class="file-upload-wrapper">   
                                    <input type="file" id="jsonFileInput" accept=".json" class="json-input" />
                                    <label for="jsonFileInput" class="upload-label" style="width:100%;height:100px;">
                                        <img src="~/assets/images/JSON_Upload_Icon.svg" />
                                        <br />
                                        <span style="font-family:'Inter';font-size:12px;color:black;">
                                            Click to Upload JSON File
                                        </span>
                                    </label>
                                    <div class="json-validation">
                                        <div class="icon-wrapper">
                                            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M20.0306 7.71938L14.7806 2.46938C14.7109 2.39975 14.6282 2.34454 14.5371 2.3069C14.4461 2.26926 14.3485 2.24992 14.25 2.25H5.25C4.85218 2.25 4.47064 2.40804 4.18934 2.68934C3.90804 2.97064 3.75 3.35218 3.75 3.75V20.25C3.75 20.6478 3.90804 21.0294 4.18934 21.3107C4.47064 21.592 4.85218 21.75 5.25 21.75H18.75C19.1478 21.75 19.5294 21.592 19.8107 21.3107C20.092 21.0294 20.25 20.6478 20.25 20.25V8.25C20.2501 8.15148 20.2307 8.05391 20.1931 7.96286C20.1555 7.87182 20.1003 7.78908 20.0306 7.71938ZM15 4.81031L17.6897 7.5H15V4.81031ZM18.75 20.25H5.25V3.75H13.5V8.25C13.5 8.44891 13.579 8.63968 13.7197 8.78033C13.8603 8.92098 14.0511 9 14.25 9H18.75V20.25Z" fill="#B68A35" />
                                            </svg>
                                        </div>

                                        <div class="file-info">
                                            <span class="file-name">No file chosen</span>
                                            <div class="progress-bar-wrapper" id="progressWrapper">
                                                <div class="progress-bar" id="progressBar"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="uploadMessage" class="upload-message"></div>
                                    <input type="hidden" id="jsonData" name="JsonData" />
                                </div>
                            </div>
                        </div>
                        <!-- Hidden Display Section -->
                        <div class="col-md-8" id="jsonDataDisplayCard">
                            <div class="card" style="padding-top:10px !important;height:100%;">
                                <span style="font-size:14px;font-weight:500;font-family:'Inter';color:black;">Uploaded File Data</span>
                                <div class="card-body" style="max-height: 300px; overflow-y: auto;padding:0px !important;">
                                    <div id="jsonDisplay" class="d-flex flex-row" style="font-size: 14px;">No data selected</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br />
                    <br />
                    <div style="padding-right: 10px">
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-primary uaeid-primary greenButton" id="TestCredentialButton" type="button" onclick="TestCredential('@Html.Raw(Model.CredentialId)')">
                                Test Credential
                            </button>
                            &nbsp;&nbsp;
                            <a asp-controller="QrCredential" asp-action="List" class="btn btn-other">
                                Cancel
                            </a>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
	$(document).ready(function () {

        $("#QR-Manager > a")
            .attr("aria-expanded", "true")
            .addClass("active");

        $("#QR-Manager")
            .addClass("submenu-active show");

        $("#QR-Manager .submenu")
            .addClass("show");

        $('#QR-Create').addClass('active');

		$('#homeMenu').addClass('breadcrumb-item').append('Qr Credential > Test Credential');
		$('#mainMenu').removeClass('breadcrumb-item');
		$('#subMenu').removeClass('breadcrumb-item');
		$('#QrCredentialsMenu').addClass('active');

        $('#networkOverlay').hide();
            document.getElementById("navigationNetworkOverlay").style.display = "none";

        const parentNavItem = document.querySelector(`[data-section="QRM"] .nav-link`);
        if (parentNavItem) {
            parentNavItem.classList.add("active");
        }


	});

	$('form').on('keypress', function (e) {
		if (e.key === 'Enter') {
			e.preventDefault();
			$('#TestCredentialButton').click();
		}
	});

	document.getElementById('jsonFileInput').addEventListener('change', function (event) {
        const file = event.target.files[0];
        const fileName = file ? file.name : 'No file chosen';
        const fileNameWithoutExt = fileName.includes('.')
            ? fileName.substring(0, fileName.lastIndexOf('.'))
            : fileName;

        $('.file-name').text(fileNameWithoutExt);

		const progressWrapper = document.getElementById('progressWrapper');
		const progressBar = document.getElementById('progressBar');
		const messageBox = document.getElementById('uploadMessage');
		const jsonInput = document.getElementById('jsonData');

        $('.json-validation').show();
        $('.json-validation').css('display', 'flex');

		progressWrapper.style.display = 'block';
		progressBar.style.width = '0%';
		progressBar.style.animation = 'none';
		void progressBar.offsetWidth;
		progressBar.style.animation = 'progressAnim 2s linear forwards';
		messageBox.style.display = 'none';
		messageBox.className = 'upload-message';

		if (!file) return;
		const reader = new FileReader();
			reader.onload = function (e) {
				setTimeout(() => {
					try {
						const json = JSON.parse(e.target.result);
						const publicData = json.Data?.publicData || [];
						const privateData = json.Data?.privateData || [];

                        const buildDisplay = (publicData, privateData) => {
                            const buildList = (title, dataArray) => {
                                let html = `<div style="flex:1;">`;

                                // header styled like table header
                                html += `<div style="background:#f9f9f9; 
                           font-weight:600; 
                           padding:10px; 
                           border-bottom:1px solid #ddd;
                           border-top-left-radius:6px; 
                           border-top-right-radius:6px;">${title}</div>`;

                                if (dataArray.length === 0) {
                                    html += `<div style="padding:10px; font-size:13px; color:#666; border:1px solid #eee; border-top:0; border-bottom-left-radius:6px; border-bottom-right-radius:6px;">
                                                No data available
                                             </div>`;
                                } else {
                                    html += `<ul style="list-style:none; padding:0; margin:0; border:1px solid #eee; border-top:0; border-bottom-left-radius:6px; border-bottom-right-radius:6px;">`;
                                    dataArray.forEach(item => {
                                        if (typeof item === "object" && item !== null) {
                                            html += `<li style="padding:8px 10px; border-bottom:1px solid #f1f1f1;">
                                ${Object.entries(item)
                                                    .map(([k, v]) => `<strong>${k}</strong>: ${typeof v === "object" ? JSON.stringify(v) : v}`)
                                                    .join("<br/>")}
                                                     </li>`;
                                        } else {
                                            html += `<li style="padding:8px 10px; border-bottom:1px solid #f1f1f1;">${item}</li>`;
                                        }
                                    });
                                    html += `</ul>`;
                                }

                                html += `</div>`;
                                return html;
                            };

                            return `<div style="display:flex; gap:20px; width:95%;padding-top:10px;"> 
                                        ${buildList("Public Data", publicData)}
                                        ${buildList("Private Data", privateData)}
                                    </div>`;
                        };


                        const displayHtml = buildDisplay(publicData, privateData);
                        document.getElementById('jsonDisplay').innerHTML = displayHtml;


						jsonInput.value = JSON.stringify(json);
						messageBox.textContent = '✅ JSON is valid!';
						messageBox.classList.add('success');

						document.getElementById('uploadCardWrapper').classList.remove('justify-content-center');
						document.getElementById('jsonDataDisplayCard').style.display = 'block';
					} catch {
						jsonInput.value = '';
						document.getElementById('jsonDisplay').innerHTML = '';
						messageBox.textContent = '❌ Invalid JSON file.';
						messageBox.classList.add('error');
					}
					messageBox.style.display = 'block';
				}, 2000);
			};


		reader.readAsText(file);
	});

	function TestCredential(CredentialId) {
		const jsonDataStr = document.getElementById('jsonData').value;
		const qrTestCredentialDTO = {
			CredentialId: CredentialId,
			Data: jsonDataStr
		};
		$.ajax({
			type: "POST",
			url: '@Url.Action("QRTestCredential", "QrCredential")',
			data: JSON.stringify(qrTestCredentialDTO),
			contentType: "application/json",
			beforeSend: function () { $('#overlay').show(); },
			complete: function () { $('#overlay').hide(); },
			success: function (data) {
				if (data.success == true) {
					Swal.fire({
						icon: 'success',
						title: "Success",
						text: "Test Credential successful. Sent for Admin Approval.",
						showCancelButton: false,
						confirmButtonText: "OK"
					}).then((result) => {
                        if (result.isConfirmed) {
                            $('#networkOverlay').show();
							window.location.href = "@Url.Action("List", "QrCredential")";
						}
					});
				} else {
					Swal.fire({
						icon: 'error',
						title: "Error",
						text: data.message,
						showCancelButton: false,
						confirmButtonText: "OK"
					}).then((result) => {
						if (result.isConfirmed) {
							window.location.href = "@Url.Action("List", "QrCredential")";
						}
					});
				}

			},
			error: ajaxErrorHandler
		});
	}
    </script>
}