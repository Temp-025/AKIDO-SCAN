@model EnterpriseGatewayPortal.Web.ViewModel.ESealRegistration.ESealRegistrationEditViewModel
@using EnterpriseGatewayPortal.Core.DTOs
@using EnterpriseGatewayPortal.Core.Domain.Services
@using EnterpriseGatewayPortal.Web.Models

@*@using DTPortal.Core.Constants*@
@*@inject IMakerCheckerService MakerCheckerService*@


@{
    //var signData = "data:image/png;base64," + Model.TemplateList.FirstOrDefault(x => x.Id == Model.SignatureTemplate).SamplePreview;
    //var esealData = "data:image/png;base64," + Model.TemplateList.FirstOrDefault(x => x.Id == Model.ESealTemplate).SamplePreview;
}

@*@{
        var makerCheckerEnabled = false;
        var activity = (await MakerCheckerService.GetAllActivities()).FirstOrDefault(x => x.Id == ActivityIdConstants.OrganizationActivityID);
        if (activity != null && activity.McEnabled)
        {
            makerCheckerEnabled = true;
        }
    }*@

@{
    ViewBag.Breadcrumb = new List<BreadCrumbModel>
{
        new BreadCrumbModel { Title = "Organization - Profile",Url = "", IconKey = "org-profile"},
    };
}

<style>
    fieldset {
        padding: 5px;
        border: groove 2px;
        padding-top: 5px;
        margin-bottom: 5px;
        overflow-y: auto;
        height: 180px;
        border: 1px solid #E2E8F0 !IMPORTANT;
        border-radius: 8px;
    }

    .sweet-alert fieldset {
        display: none;
    }

    .sweet-alert p {
        font-weight: 400;
        overflow: auto;
        max-height: 200px;
        white-space: break-spaces;
    }

    a.dropdown-item:hover {
        color: #212529 !important;
    }

    .signatoryEmailListInput {
        width: 50%;
        padding-left: 5px;
        border: none;
    }

    .directorEmailListInput {
        width: 93%;
        padding-left: 5px;
        border: none;
    }

    .clearliSignatory, .clearliDirector {
        margin-left: 5px;
        width: 22px;
        border: 1px;
        border-radius: 12px;
    }

    .signatoryEmailListInput:hover, .directorEmailListInput:hover {
        outline: none !important;
        border: none !important;
    }

    .signatoryEmailListInput:focus, .directorEmailListInput:focus {
        outline: none !important;
        border: none !important;
    }

    #signatoriesLegend {
        display: block;
        width: auto;
        max-width: 100%;
        padding: 0;
        margin-bottom: -0.3rem;
        font-size: 1.1rem;
        line-height: inherit;
        color: inherit;
        white-space: normal;
    }

    #directorLegend {
        display: block;
        width: auto;
        max-width: 100%;
        padding: 0;
        margin-bottom: -0.3rem;
        font-size: 1.1rem;
        line-height: inherit;
        color: inherit;
        white-space: normal;
    }

    .custom-file-upload {
        background: #f7f7f7;
        padding: 3px 10px;
        border: 1px solid #e3e3e3;
        border-radius: 5px;
        border: 1px solid #ccc;
        display: inline-block;
        cursor: pointer;
    }

    .popup-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .popup-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 5px;
        max-width: 400px;
        text-align: center;
    }

    .preview-container {
        position: relative;
        margin-bottom: 20px;
        height: 250px;
        overflow: hidden;
    }

    .preview-image {
        max-width: 100%;
        max-height: 100%;
        display: block;
        margin: 0 auto;
    }

    .button-container {
        display: flex;
        justify-content: center;
    }

        .button-container button {
            margin: 0 5px;
        }

    .form-check-input[readonly] {
        background-color: black;
        border-color: #333;
        color: white;
    }

    .classshide {
        display: none !important;
    }

    .card-custom {
        border: 1px solid #E1E3E5;
        border-radius: 12px;
        padding: 24px;
        background: #fff;
        margin-bottom: 24px;
        height: 85%;
    }


    .section-title {
        font-size: 16px !important;
        font-family: "Inter";
        font-weight: 600;
        margin-bottom: 16px;
        padding: 0px 24px;
        color: #000;
    }

    .profile-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px 40px;
    }

        .profile-grid label {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 4px;
            display: block;
        }

        .profile-grid p {
            font-size: 14px;
            font-weight: 600;
            color: #000;
            margin: 0;
            text-align:start;
        }

    .form-group {
        margin-bottom: 20px;
    }

        .form-group label {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 6px;
            display: block;
        }

    .input-group {
        display: flex;
        align-items: stretch;
    }

        .input-group .form-control {
            border: 1px solid #E1E3E5;
            border-radius: 6px 0 0 6px;
            font-size: 14px;
            height: 44px;
        }

    .btn-gold {
        background: linear-gradient(90deg, #b58d2f, #d1a84c);
        color: white;
        border: none;
        border-radius: 0 6px 6px 0;
        padding: 0 18px;
        font-size: 14px;
        font-weight: 600;
        height: 44px;
    }

        .btn-gold:active {
            background-image: linear-gradient(90deg, #a07c28, #b58d2f);
            box-shadow: none !important;
        }

        .btn-gold:focus {
            box-shadow: none !important;
        }

    .individual-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .form-group label {
        color: black;
        font-weight: 500;
        font-style: normal;
        font-size: 16px;
        line-height: 24px;
        letter-spacing: 0px;
        display: inline-block;
        margin-bottom: 10px;
    }

    .form-group {
        margin-bottom: 20px !important;
    }

    .info-label {
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
    }

    .hidden-input {
        display: none;
    }

    .status-container {
        display: flex;
        align-items: baseline;
        gap: 8px;
    }

    .status-text {
        margin: 0;
        font-size: 14px;
        color: #555;
    }

    #info-icon {
        font-size: 16px;
        color: #92722A;
        cursor: pointer;
        transition: color 0.2s;
    }

    @@media (width <= 768px) {
        .mobile-media {
            flex-direction: column !important;
        }

        .width-100 {
            width: 100% !important;
        }
    }
</style>
<div class="classshide">
    <div id='viewer'></div>
</div>

<div class="row mobile-media">
    <!-- Left: Organization Profile -->
    <div class="col-md-6 d-flex pl width-100" style="padding-left:25px;padding-right:0px !important;">
        <div class="w-100">
            <h5 class="section-title">Organization Profile</h5>
            <div class="card-custom">
                <div class="profile-grid">
                    <div class="individual-info">
                        <label>Organization Name</label>
                        <p>@Model.OrganizationName</p>
                    </div>
                    <div class="individual-info">
                        <label>Organization Email</label>
                        <p>@Model.OrganizationEmail</p>
                    </div>

                    <div class="individual-info">
                        <label>Tax Number (TAN)</label>
                        <p>@(string.IsNullOrEmpty(Model.TaxNo) ? "N/A" : Model.TaxNo)</p>
                    </div>
                    <div class="individual-info">
                        <label>Unique Registered Number</label>
                        <p>@(string.IsNullOrEmpty(Model.UniqueRegdNo) ? "N/A" : Model.UniqueRegdNo)</p>
                    </div>

                    <div class="individual-info">
                        <label>Corporate Office Address (Building, Street)</label>
                        <p>@Model.CorporateOfficeAddress1</p>
                    </div>
                    <div class="individual-info">
                        <label>Corporate Office Address (Area, City)</label>
                        <p>@Model.CorporateOfficeAddress2</p>
                    </div>

                    <div class="individual-info">
                        <label>Country</label>
                        <p>@Model.Country</p>
                    </div>
                    <div class="individual-info">
                        <label>Zip code</label>
                        <p>@Model.Pincode</p>
                    </div>

                    <div class="individual-info">
                        <label>Organization Status</label>
                        <p>@Model.Status</p>
                    </div>
                    @*<div class="individual-info">
                        <label class="info-label">Eseal Certificate Status</label>
                        <input type="hidden" id="certificateStatus" value="@Model.certificateStatus" />
                        <input id="certificateStartDate" class="hidden-input" value="@Model.certificateStartDate" />
                        <input id="certificateEndDate" class="hidden-input" value="@Model.certificateEndDate" />

                        <div class="status-container">
                            <p class="status-text">@Model.certificateStatus</p>
                            <i id="info-icon" class="fa fa-info-circle" onclick="showTooltip()"></i>
                        </div>
                    </div>*@

                    <!-- Subscription Type moved here -->
                    @*<div class="individual-info">
                        <label>Subscription Type</label>
                        <p>@(Model.EnablePostPaidOption ? "Postpaid" : "Prepaid")</p>
                    </div>*@
                </div>
            </div>
        </div>
    </div>

    <!-- Right: Configurations -->
    <div class="col-md-6 d-flex pl width-100" style="padding-left:25px;padding-right:0px !important;">
        <div class="w-100">
            <h5 class="section-title">Configurations</h5>
            <div class="card-custom">
                <div class="form-group">
                    <label>Spoc Email</label>
                    <div class="input-group">
                        <input asp-for="SpocUgpassEmail" class="form-control" />
                        <button type="button" class="btn btn-gold" onclick="updateSpocEmail()">Update</button>
                    </div>
                </div>

                @*<div class="form-group">
                    <label>Agent URL</label>
                    <div class="input-group">
                        <input asp-for="AgentUrl" class="form-control" />
                        <button type="button" class="btn btn-gold" onclick="updateAgentUrl()">Update</button>
                    </div>
                </div>*@

                <div class="form-group">
                    <label>Email Domain</label>
                    <div class="input-group">
                        <input asp-for="EmailDomain" class="form-control" />
                        <button type="button" class="btn btn-gold" onclick="updateEmailDomain()">Update</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-12" style="padding-right:35px !important;margin-bottom:20px !important;">
        <button id="previlages" type="button" class="btn btn-primary uaeid-primary d-flex justify-content-around align-items-center flex-row" style="gap:10px;float:right;">
            <img src="~/assets/images/view-icon.svg" height="14" />
            View Privileges
        </button>

    </div>
</div>




<script src="~/lib/jquery-validation/dist/jquery.validate.min.js" asp-append-version="true"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js" asp-append-version="true"></script>
<script src="~/lib/jquery-ajax-unobtrusive/jquery.unobtrusive-ajax.min.js" asp-append-version="true"></script>

<script>

    Swal = Swal.mixin({
        customClass: {
            popup: 'custom-swal-popup',
            title: 'custom-swal-title',
            htmlContainer: 'custom-swal-content',
            confirmButton: 'custom-swal-confirm-btn',
            cancelButton: 'custom-swal-cancel-btn'
        },
        buttonsStyling: false
    });

    var signatoryEmailIndex = 0;
    var directorEmailIndex = 0;
    var emailRegex = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
     //var urlRegex = /^(https?:\/\/)?([\w-]+\.)+([a-zA-Z]{2,5})(:\d{1,5})?(\/[\w-./?%&=]*)?$/;
     var urlRegex = /^$|^(https?:\/\/)?([\w-]+\.)+([a-zA-Z]{2,5})(:\d{1,5})?(\/[\w-./?%&=]*)?$/; //accepts emty string regex

        var allowedImageFileTypes = ['jpg', 'jpeg', 'png'];
        var allowedCSVFileTypes = ['.csv'];

        //new obj for store  generate eseal data
        var GenerateEsealData = {
            "organizationUID":"",
            "organizationName":"",
            "transactionId":"",
            "enablePostPaidOption": ""
       };
       var stakeHolderOrgUID = {
           "referedById":""
       }
    $(document).ready(function () {
        $("#previlages").click(function () {
            // Mock privileges from the model (Replace with actual data from backend)
             var privileges = '@Html.Raw(Json.Serialize(Model.Previlages))'; // If using Razor Model

            var $list = $(".privileges-container");
             $list.empty(); // Clear previous data

             if (privileges && privileges.length > 0) {
                 // Append privileges as list items
                 privileges.forEach(function (priv) {
                     if (priv == "credential_issuer") {
                         var newItem = `<div style=" gap: 10px; flex-direction: column; display: flex; border-radius: 16px; align-items: center; justify-content: center; background: rgba(249, 247, 237, 1); border: 1px solid rgba(146, 114, 42, 1); height: 135px; width: 180px; padding: 16px;">
                                               <img src="@Url.Content("~/assets/images/Credential-Issuer-Icon.svg")" height="60" />
                                            <span
                                                  style="font-family: Roboto; font-weight: 500; font-size: 18px; line-height: 28px; color: rgba(146, 114, 42, 1); "
                                                  >Credential Issuer</span>
                                        </div>`
                        $list.append(newItem);
                     }
                    if (priv == "credential_verifier") {
                        var newItem = `<div style=" gap: 10px; flex-direction: column; display: flex; border-radius: 16px; align-items: center; justify-content: center; background: rgba(249, 247, 237, 1); border: 1px solid rgba(146, 114, 42, 1); height: 135px; width: 180px; padding: 16px;">
                                <img src="@Url.Content("~/assets/images/Credential-Verifier-Icon.svg")" height="60" />

                                            <span
                                                style="font-family: Roboto; font-weight: 500; font-size: 18px; line-height: 28px; color: rgba(146, 114, 42, 1); "
                                                >Credential Verifier</span>
                                        </div>`
                        $list.append(newItem);
                    }

                 });
             } else {
                 // Show "No privileges present" message
                 $list.append('<li class="text-danger">No privileges present for this organization.</li>');
             }

             // Show the modal
             $("#privilegesModal").modal("show");
         });




        $('#networkOverlay').hide();
        document.getElementById("navigationNetworkOverlay").style.display = "none";

        //var orgDetail = document.getElementById('OrgDetailsModle').querySelector('.nav-link');
        //orgDetail.click();

        $("#OrgDetailsModle > a")
            .attr("aria-expanded", "true")
            .addClass("active");

        $("#OrgDetailsModle")
            .addClass("submenu-active show");

        $("#OrgDetailsModle .submenu")
            .addClass("show");

        $('#OrganizationProfile').addClass('active');

        $('#homeMenu').addClass('breadcrumb-item').append('Organization Details > Organization');
        $('#mainMenu').removeClass('breadcrumb-item');
        $('#subMenu').removeClass('breadcrumb-item');
        //delinkTable
         $('input[type="checkbox"][readonly]').on('click', function () {
            return false;
        });
        var table = $("#delinkTable");

        if(table != undefined){
            table.DataTable({
            "bPaginate": false,
            "bLengthChange": false,
            "searching": true
        });
        }


        signatoryEmailIndex = $('#signatory-email-list').children('li').length;
        if (signatoryEmailIndex > 0) {
            $('#addSignatoryEmailFieldset').show();
        }


    @{
        if (!String.IsNullOrEmpty(Model.TaxNo))
        {
            @:$('#TaxNo').show();
            @:$('input[data-id="TaxNo"]').prop("checked", true);
        }


        if (!String.IsNullOrEmpty(Model.UniqueRegdNo))
        {
            @:$('#UniqueRegdNo').show();
            @:$('input[data-id="UniqueRegdNo"]').prop("checked", true);
        }

        if (Model.DirectorsEmailList != null && Model.DirectorsEmailList.Count > 0)
        {
            foreach (var directorEmail in Model.DirectorsEmailList)
            {
                @:addDirectorEmail('@directorEmail');
            }
            @:$('#addDirectorFieldset').show();
        }
    }

         $("#updateBtn").click(function (e) {
                e.preventDefault();

                if (formValidation()) {
                    var isValid = true;

                    $("#checkbox-list li").each(function () {
                        var text = $(this).find('input[type=text]').val();
                        switch (text) {
                            case "Authorized Letter for Signatories":
                                if ($(this).find('input[type=checkbox]').is(':checked')) {
                                    var file = $("#AuthorizedLetterForSignatories").get(0).files[0];
                                    if (file == undefined || file.size < 0) {
                                        @if (String.IsNullOrEmpty(Model.AuthorizedLetterForSignatoriesBase64))
                                        {
                                            <text>
                                                $("span[data-valmsg-for='AuthorizedLetterForSignatories']").html("Please select file");
                                                isValid = false;
                                             </text>
                                        }
                                    }
                                }
                                break;

                            case "E-seal Image":
                                if ($(this).find('input[type=checkbox]').is(':checked')) {
                                    var file = $("#ESealImage").get(0).files[0];
                                    if (file == undefined || file.size < 0) {

                                        @if (@String.IsNullOrEmpty(Model.ResizedEsealImage))
                                        {
                                            <text>
                                                $("span[data-valmsg-for='ESealImage']").html("Please select file");
                                                isValid = false;
                                            </text>
                                        }
                                    }
                                }
                                break;

                            case "Incorporation":
                                if ($(this).find('input[type=checkbox]').is(':checked')) {
                                    var file = $("#Incorporation").get(0).files[0];
                                    if (file == undefined || file.size < 0) {
                                        
                                            @if (@String.IsNullOrEmpty(Model.IncorporationBase64))
                                            {
                                                <text>
                                                    $("span[data-valmsg-for='Incorporation']").html("Please select file");
                                                    isValid = false;
                                                </text>
                                            }
                                        
                                    }
                                }
                                break;

                            case "Tax":
                                if ($(this).find('input[type=checkbox]').is(':checked')) {
                                    var file = $("#Tax").get(0).files[0];
                                    if (file == undefined || file.size < 0) {
                                        @if (@String.IsNullOrEmpty(Model.TaxBase64))
                                        {
                                            <text>
                                                $("span[data-valmsg-for='Tax']").html("Please select file");
                                                isValid = false;
                                            </text>
                                        }
                                    }
                                }
                                break;

                            case "Additional Legal Document":
                                if ($(this).find('input[type=checkbox]').is(':checked')) {
                                    var file = $("#AdditionalLegalDocument").get(0).files[0];
                                    if (file == undefined || file.size < 0) {
                                        @if (String.IsNullOrEmpty(Model.AdditionalLegalDocumentBase64))
                                        {
                                        <text>
                                            $("span[data-valmsg-for='AdditionalLegalDocument']").html("Please select file");
                                            isValid = false;
                                        </text>
                                        }
                                    }
                                }
                                break;
                        }
                    });
                    if (!isValid) {
                        return false;
                    }
                    else {
                        var subscriberArray = [];
                        $('#signatory-email-list li').each(function () {
                            subscriberArray.push($(this).find(".signatoryEmailListInput").val());
                        });

                        var postData = { values: subscriberArray };

                            @if (Model.Status.ToLower() == "active")
                            {
                                    <text>verifyDocumentAndUpdateCall('@Model.OrganizationUID', '@Model.OrganizationName');</text>
                            }
                            else
                            {
                                    <text>updateCall();</text>
                            }
                    }
                }
                else {
                    //return swal({ type: 'error', title: "Error", text: errorMessage });
                    return showAlert('error', errorMessage);
                }
         });

        $("#eSealEditForm").on("submit", function (event) {
            event.preventDefault();
        });



        $('#SignedPdf').change(function () {
            $(this).next('label').text("");
            $(this).prev('label').text('Upload Signed Document');
            var i = $(this).prev('label').clone();
            var file = $('#SignedPdf')[0].files[0].name;
            $(this).next('label').text(file);
        });

        $('#Pincode').keyup(function () {
            if (this.value != this.value.replace(/[^0-9\.]/g, '')) {
                this.value = this.value.replace(/[^0-9\.]/g, '');
                $("span[data-valmsg-for='Pincode']").text("Only Numbers allowed");
            }
            else {
                $("span[data-valmsg-for='Pincode']").text("");
            }
        });

        $("#eSealPreviewImage").attr('src', 'data:image/jpg;base64,' + '@Html.Raw(Model.ResizedEsealImage)');

        $('.optional-checkbox').on('click', function () {
            $("#" + $(this).attr('data-id')).val('');
            if ($(this).prop('checked')) {
                $("#" + $(this).attr('data-id')).show();
            } else {
                $("#" + $(this).attr('data-id')).hide();
            }
        });

        $('#SignatureTemplate').change(function () {
            var preview = $('option:selected', this).attr('data-preview');

            $("#signatureTemplatePreviewImage").attr("src", "data:image/png;base64," + preview);
        });

        $('#ESealTemplate').change(function () {
            var preview = $('option:selected', this).attr('data-preview');

            $("#eSealTemplatePreviewImage").attr("src", "data:image/png;base64," + preview);
        });


    });

    function updateSpocEmail() {

        // Get the updated values from the input fields
        var updatedSpocEmail = document.getElementById('SpocUgpassEmail').value;

        if (updatedSpocEmail == "") {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Spoc Email is required.'
            });
            return;
        }
        if (!emailRegex.test(updatedSpocEmail)) {

            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Invalid Email address'
            });

            return;
        }





        var viewModel = {
            "SpocUgpassEmail": updatedSpocEmail
        };

        $.ajax({
            type: "POST",
            url: '@Url.Action("UpdateSpocEmail", "ESealRegistration")',
            data: viewModel,
            dataType: "json",
            beforeSend: function () {
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                if (data.status == "Success") {
                    Swal.fire({
                        icon: 'success',
                        title: "Success",
                        text: "SPOC Email updated successfully."
                    }, function (isConfirm) {
                        if (isConfirm) {
                            window.location.href = '@Url.Action("GetOrganizationById", "ESealRegistration")';
                        }
                    });
                } else if (data.status == "Failed") {
                    Swal.fire({ icon: 'error', title: "Error", text: data.message }, function (isConfirm) {
                        if (isConfirm) {
                            window.location.href = '@Url.Action("GetOrganizationById", "ESealRegistration")';
                        }
                    });
                }
            }
        });

    }

    function updateAgentUrl() {
        var updatedAgentUrl = document.getElementById('AgentUrl').value;
        var updatedSpocEmail = document.getElementById('SpocUgpassEmail').value;

            if (!urlRegex.test(updatedAgentUrl)) {
                Swal.fire({
                    icon: 'info',
                    title: 'Invalid Agent Url',
                    text: 'Please enter a valid Agent Url.'
                });
                return;
            }




        var viewModel = {
            "AgentUrl": updatedAgentUrl,
            "SpocUgpassEmail": updatedSpocEmail
        };

        $.ajax({
            type: "POST",
            url: '@Url.Action("UpdateAgentUrl", "ESealRegistration")',
            data: viewModel,
            dataType: "json",
            beforeSend: function () {
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                if (data.status == "Success") {
                    Swal.fire({
                        icon: 'success',
                        title: "Success",
                        text: "Agent URL updated successfully."
                    }, function (isConfirm) {
                        if (isConfirm) {
                            window.location.href = '@Url.Action("GetOrganizationById", "ESealRegistration")';
                        }
                    });
                } else if (data.status == "Failed") {
                    Swal.fire({ type: 'error', title: "Error", text: data.message }, function (isConfirm) {
                        if (isConfirm) {
                            window.location.href = '@Url.Action("GetOrganizationById", "ESealRegistration")';
                        }
                    });
                }
            }
        });

    }

    function updateEmailDomain() {

        var updatedEmailDomain = document.getElementById('EmailDomain').value;
        var domainPattern = /^@@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

        if (!domainPattern.test(updatedEmailDomain)) {
            Swal.fire({
                icon: 'error',
                title: "Invalid Email Domain",
                text: "Please enter a valid email domain"
            });
            return;
        }

        var viewModel = {
            "EmailDomain": updatedEmailDomain,

        };

        $.ajax({
            type: "POST",
            url: '@Url.Action("UpdateEmailDomain", "ESealRegistration")',
            data: viewModel,
            dataType: "json",
            beforeSend: function () {
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                if (data.status == "Success") {
                    Swal.fire({
                        type: 'success',
                        title: "Success",
                        text: "Email Domain updated successfully."
                    }, function (isConfirm) {
                        if (isConfirm) {
                            window.location.href = '@Url.Action("GetOrganizationById", "ESealRegistration")';
                        }
                    });
                } else if (data.status == "Failed") {
                    Swal.fire({ type: 'error', title: "Error", text: data.message }, function (isConfirm) {
                        if (isConfirm) {
                            window.location.href = '@Url.Action("GetOrganizationById", "ESealRegistration")';
                        }
                    });
                }
            }
        });

    }

    function updateCall() {

        var model = new FormData($('Form').get(0));

        $.ajax({
            type: "POST",
            url: '@Url.Action("Update", "ESealRegistration")',
            headers: {
                "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
            },
            data: model,
            processData: false,
            contentType: false,
            error: ajaxErrorHandler,
            beforeSend: function () {
                $('#overlay2').show();
            },
            complete: function () {
                $('#overlay2').hide();
            },
            success: function (data) {
                if (data.status == "Success") {
                    Swal.fire({
                        type: 'success', title: "Success", text: data.message
                    }, function (isConfirm) {
                        if (isConfirm) {
                            window.location.href = '@Url.Action("Index", "ESealRegistration")'
                        }
                    });
                }
                if (data.status == "Failed") {
                    Swal.fire({ type: 'error', title: "Error", text: data.message });
                }
            }
        });
    }

    function verifyDocumentAndUpdateCall(organizationUID, organizationName) {
        var subscriberArray = [];
        //$('#signatory-email-list li').each(function () {
        //    subscriberArray.push($(this).find(".signatoryEmailListInput").val());
        //});
        subscriberArray.push($("#SpocUgpassEmail").val());

        var data =
        {
            'organizationUID': organizationUID,
            'organizationName': organizationName,
            'emails': subscriberArray,
            'transactionId': "",
            'enablePostPaidOption':"",
            'signedPdf': null,
            'ESealActionMethod': 'update_eseal'
        };

        verifyDocumentCall(data);
    }

    function verifyDocumentCall(data) {

        $.ajax({
            type: "GET",
            url: '@Url.Action("UploadSignedDocument", "ESealRegistration")',
            contentType: "application/json; charset=utf-8",
            data: data,
            datatype: "json",
            traditional: true,
            beforeSend: function () {
                $('#overlay1').hide();
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                $('#modalDialogContentDiv').html(data);
                $('#modalDialogDiv').modal('show');
            },
            error: ajaxErrorHandler,
            failure: function (response) {
                Swal.fire({ icon: 'error', title: "Error", text: "Cannot process your request" });
            }
        });
    }

     //to get Organization Payment history list
    function getOrganizationPaymentHistory(uid, name) {
       GenerateEsealData.organizationUID = uid;
       GenerateEsealData.organizationName = name;
        var dataToSend = { organizationUid: uid, organizationName: name };
        $.ajax({
            url: '@Url.Action("GetOrganizationPaymentHistory", "ESealRegistration")',
            data: dataToSend,
            type: "GET",
            error: ajaxErrorHandler,
            beforeSend: function () {
                $('#overlay1').hide();
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {

               if(typeof data == "object")
               {
                    Swal.fire({
                    icon:"info",
                    title:"Payment Info",
                    text: "Eseal Certificate Payment Not Done"
                    }, function (isConfirm) {
                        if (isConfirm) {

                            $('#getPaymenthistory').css("display", "block");
                        }
                   });
               }else{
                    $('#modalDialogContentDiv').html(data);
                    $('#modalDialogDiv').modal('show');
               }
            }
        });
    }

    //Payment history next btn event
    function validatePaymentHistory(transactionId) {
        var enablePostPaidOption = $('#EnablePostPaidOption').val();
        GenerateEsealData.enablePostPaidOption = enablePostPaidOption;
        GenerateEsealData.TransactionId = transactionId;
        verifyDocumentAndGenerateEsealCall(GenerateEsealData.organizationUID, GenerateEsealData.organizationName, enablePostPaidOption, transactionId)
    }


    function generateEseal(organizationUID, organizationName) {
        verifyDocumentAndGenerateEsealCall(organizationUID, organizationName);
    }

    //Old
    function verifyDocumentAndGenerateEsealCallOld(organizationUID, organizationName) {
        var subscriberArray = [];
        //$('#signatory-email-list li').each(function () {
        //    //if ($(this).find('div').children().eq(1).prop('checked') == true)
        //    //{
        //    subscriberArray.push($(this).find(".signatoryEmailListInput").val());
        //    //}
        //});
        subscriberArray.push($("#SpocUgpassEmail").val());

        var data =
        {
            'organizationUID': organizationUID,
            'organizationName': organizationName,
            'emails': subscriberArray,
            'signedPdf': null,
            'ESealActionMethod': 'generate_eseal'
        };

        verifyDocumentCall(data);
    }

    //Old
    function generateEsealCallOld(organizationUID, organizationName) {
        $.ajax({
            type: "POST",
            url: '@Url.Action("GenerateEseal", "ESealRegistration")',
            headers: {
                "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
            },
            data: { "organizationUID": organizationUID, "organizationName": organizationName },
            error: ajaxErrorHandler,
            beforeSend: function () {
                $('#overlay2').show();
            },
            complete: function () {
                $('#overlay2').hide();
            },
            success: function (data) {
                if (data.status == "Success") {
                    Swal.fire({
                        type: 'success', title: "Success", text: data.message
                    }, function (isConfirm) {
                        if (isConfirm) {
                            $('#organizationDiv').empty();
                            getOrganizationDetails('@Model.OrganizationName');
                        }
                    });
                }
                if (data.status == "Failed") {
                    Swal.fire({ type: 'error', title: "Error", text: data.message });
                }
            }
        });
    }

     //New
    function verifyDocumentAndGenerateEsealCall(organizationUID, organizationName, enablePostPaidOption, transactionId) {
        var subscriberArray = [];
        subscriberArray.push($("#SpocUgpassEmail").val());

        var data =
        {
            'organizationUID': organizationUID,
            'organizationName': organizationName,
            'emails': subscriberArray,
            'transactionId': transactionId,
            'enablePostPaidOption':enablePostPaidOption,
            'signedPdf': null,
            'ESealActionMethod': 'generate_eseal'
        };

        verifyDocumentCall(data);
    }

    //New
     function generateEsealCall(organizationUID, organizationName, transactionId) {



        $.ajax({
            type: "POST",
            url: '@Url.Action("GenerateEseal", "ESealRegistration")',
            headers: {
                "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
            },
            data: { "organizationUID": organizationUID, "organizationName": organizationName, "transactionId": transactionId },
            error: ajaxErrorHandler,
            beforeSend: function () {
                $('#overlay2').show();
            },
            complete: function () {
                $('#overlay2').hide();
            },
            success: function (data) {
                if (data.status == "Success") {
                    Swal.fire({
                        icon: 'success', title: "Success", text: data.message
                    }, function (isConfirm) {
                        if (isConfirm) {
                            $('#organizationDiv').empty();
                            getOrganizationDetails('@Model.OrganizationName');
                        }
                    });
                }
                if (data.status == "Failed") {
                    Swal.fire({ icon: 'error', title: "Error", text: data.message });
                }
            }
        });
    }

    function revoke(organizationUID, organizationName) {
        var requestBody = {
            "organizationUID": organizationUID,
            "organizationName": organizationName
        };

        $.ajax({
            type: "GET",
            url: '@Url.Action("RevokeCertificate", "ESealRegistration")',
            headers: {
                "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
            },
            contentType: "application/json; charset=utf-8",
            data: requestBody,
            datatype: "json",
            beforeSend: function () {
                $('#overlay1').hide();
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                $('#modalDialogContentDiv').html(data);
                $('#modalDialogDiv').modal('show');
            },
            error: ajaxErrorHandler,
            failure: function (response) {
                Swal.fire({ type: 'error', title: "Error", text: "Cannot process your request" });
            }
        });
    }

    function registeredClients(organizationUID) {

        $.ajax({
            type: "GET",
            url: '@Url.Action("RegisteredClients", "ESealRegistration")',
            contentType: "application/json; charset=utf-8",
            data: { organizationUid: organizationUID },
            datatype: "json",
            beforeSend: function () {
                $('#overlay1').hide();
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                $('#modalDialogContentDiv').html(data);
                $('#modalDialogDiv').modal('show');
            },
            error: ajaxErrorHandler,
            failure: function (response) {
                Swal.fire({ type: 'error', title: "Error", text: "Cannot process your request" });
            }
        });
    }

    function registeredStakeHolders(organizationUID) {
        stakeHolderOrgUID.referedById = organizationUID;

        $.ajax({
            type: "GET",
            url: '@Url.Action("GetStakeholderList", "ESealRegistration")',
            contentType: "application/json; charset=utf-8",
            data: { organizationUid: organizationUID },
            datatype: "json",
            beforeSend: function () {
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                $('#modalDialogContentDiv').html(data);
                $('#modalDialogDiv').modal('show');
            },
            error: ajaxErrorHandler,
            failure: function (response) {
                Swal.fire({ type: 'error', title: "Error", text: "Cannot process your request" });
            }
        });
    }

    function downloadDocument(name) {
        var exportType;
        switch (name) {
            case "AuthorizedLetterForSignatories":
                exportType = "pdf";
                saveByteArray(name, '@Html.Raw(@Model.AuthorizedLetterForSignatoriesBase64)', exportType)
                break;

            case "ESealImage":
                exportType = "jpg";
                saveByteArray(name, '@Html.Raw(@Model.ResizedEsealImage)', exportType)
                break;

            case "Incorporation":
                exportType = "pdf";
                saveByteArray(name, '@Html.Raw(@Model.IncorporationBase64)', exportType)
                break;

            case "Tax":
                exportType = "pdf";
                saveByteArray(name, '@Html.Raw(@Model.TaxBase64)', exportType)
                break;

            case "AdditionalLegalDocument":
                exportType = "pdf";
                saveByteArray(name, '@Html.Raw(@Model.AdditionalLegalDocumentBase64)', exportType)
                break;
        }
    }

    function showTooltip()
    {


                var certificateStatus = $('#certificateStatus').val();
                var tooltipText = '';

                if (certificateStatus == "ACTIVE") {
                    var startTime =  $('#certificateStartDate').val();
                    var endTime = $('#certificateEndDate').val();
                    var formattedstartTime = startTime.replace("T", "  T");
                    var formattedendTime = endTime.replace("T", "  T");
                    Swal.fire({ icon: 'success', title: "Eseal Certificate Details", text: 'GENERATED ON  :  ' + formattedstartTime + '\nEXPIRY DATE       :  ' + formattedendTime });
                }
                else if (certificateStatus == "EXPIRED") {
                    var startTime = $('#certificateStartDate').val();
                    var endTime = $('#certificateEndDate').val();
                    var formattedstartDate = startDate.replace("T", "  T");
                    var formattedendDate = endDate.replace("T", "  T");
                    Swal.fire({ icon: 'error', title: "Eseal Certificate Details", text: 'GENERATED ON  :  ' + formattedstartDate + '\nEXPIRY DATE       :  ' + formattedendDate });
                }
                else if (certificateStatus == "NOT ISSUED") {
                    Swal.fire({ icon: 'info', title: "Eseal Certificate Details", text: "Certificate was not issued to this Organization" });
                }
                else{
                    Swal.fire({icon: 'error', title: "Eseal Certificate Details",text: "Something went wrong. Please try after sometime"});
                }

    }

    function delinkUser(email, orgId, index) {

        var date = $('#' + index + '').val();
        var postData = {
            "employeeEmail": email,
            "organizationUID": orgId,
            "endDate": ""
        }

        $.ajax({
            type: "POST",
            url: '@Url.Action("DelinkOrganizationEmployee", "ESealRegistration")',
            headers: {
                "XSRF-TOKEN": $('input[name="__RequestVerificationToken"]').val()
            },
            data: postData,
            beforeSend: function () {
                $('#modalDiv').modal('hide');
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                if (data.status == "Success") {

                    Swal.fire({
                        type: 'success', title: "Success", text: data.message
                    }, function (isConfirm) {
                        if (isConfirm) {
                            $('#organizationDiv').empty();
                            getOrganizationDetails('@Model.OrganizationName');
                        }
                    });
                }
                if (data.status == "Failed") {

                    Swal.fire({
                        type: 'error', title: "Error", text: data.message
                    }, function (isConfirm) {
                        if (isConfirm) {
                            $('#organizationDiv').empty();
                            getOrganizationDetails('@Model.OrganizationName');
                        }
                    });
                }
            },
            error: ajaxErrorHandler,
            failure: function (response) {
                Swal.fire({ type: 'error', title: "Error", text: "Cannot process your request" });
            }
        });
    }

    function delinkOrganizationUser() {
        $('#modalDiv').modal('show');
    }


    function addSignatoryEmail(value, isUploaded, arr, signData, ugpassEmail) {
    @{
        Model.OrganizationUsersList.Add(new OrganizationUser());
    }

        var maxSize = 20;
        var signatory = "";
        var nin = "";
        var passportNumber = "";
        var ugPassEmail = "";
        var mobileNumber = "";
        var designation = "";
        var signaturePhoto = "";
        var affixEseal = "";
        var prepatory = "";
        var delegation = "";
        var bulksigner = "";
        var isSignPhotoAvailable = "none";

        if (!isUploaded) {

            affixEseal = (arr[0] == "checked") ? "checked" : "";
            prepatory = (arr[1] == "checked") ? "checked" : "";
            bulksigner = (arr[2] == "checked") ? "checked" : "";
            delegation = (arr[3] == "checked") ? "checked" : "";

            ugPassEmail = signData[0];
            nin = signData[1];
            passportNumber = signData[2];

            mobileNumber = signData[3];
            designation = signData[4];
            signaturePhoto = signData[5];
        } else {
            delegation = (arr[0] == "1") ? "checked" : "";
            affixEseal = (arr[1] == "1") ? "checked" : "";
            prepatory = (arr[2] == "1") ? "checked" : "";
            bulksigner = (arr[3] == "1") ? "checked" : "";
            ugPassEmail = ugpassEmail;
            designation = signData[0];
            signaturePhoto = signData[1];
            nin = signData[2];
            mobileNumber = signData[3];
            passportNumber = signData[4];
        }

        if (signaturePhoto != "") {
                isSignPhotoAvailable = "block";
            }else{
                isSignPhotoAvailable = "none";
            }

            var li = "<li style='margin-top: 2px;margin-bottom: 2px; display:flex'>" +
            "<div class='form-row col-md-12' style='height:25px'>" +
            "<input name='OrganizationUsersList.index' value='" + signatoryEmailIndex + "' style='display: none;' />" +

            "<div>" +
            "<textarea type='text' style='display:none' class='ugpassEmailListInput' id='OrganizationUsersList_" + signatoryEmailIndex + "__Ugpassemail' name='OrganizationUsersList[" + signatoryEmailIndex + "].Ugpassemail' value='" + ugPassEmail + "' readonly>" + ugPassEmail + "</textarea>" +
            "</div>" +

            "<div>" +
            "<input type='text' /*style='height:23px'*/ class='form-control ninListInput' id='OrganizationUsersList_" + signatoryEmailIndex + "__NationalIdNumber' name='OrganizationUsersList[" + signatoryEmailIndex + "].NationalIdNumber' value='" + nin + "' hidden/>" +
            "</div>" +
            "<div>" +
            "<input type='text' /*style='height:23px'*/ class='form-control passportNumberListInput' id='OrganizationUsersList_" + signatoryEmailIndex + "__PassportNumber' name='OrganizationUsersList[" + signatoryEmailIndex + "].PassportNumber' value='" + passportNumber + "' hidden/>" +
            "</div>" +

            "<div>" +
            "<input type='text' /*style='height:23px'*/ class='form-control mobileNumberListInput' id='OrganizationUsersList_" + signatoryEmailIndex + "__MobileNumber' name='OrganizationUsersList[" + signatoryEmailIndex + "].MobileNumber' value='" + mobileNumber + "' hidden/>" +
            "</div>" +

            "<div class='col-md-3'>" +
            "<textarea type='text' style='resize: none;white-space: nowrap;width:100%;' class='signatoryEmailListInput' id='OrganizationUsersList_" + signatoryEmailIndex + "__EmployeeEmail' name='OrganizationUsersList[" + signatoryEmailIndex + "].EmployeeEmail' value='" + value + "' readonly>" + value + "</textarea>" +
            "</div>" +

            "<div class='col-md-1' style='padding-left: 3.5%;'>" +
            "<input type='checkbox' class='custom-check-box' id='OrganizationUsersList_" + signatoryEmailIndex + "__Delegate' name='OrganizationUsersList[" + signatoryEmailIndex + "].Delegate' onclick='return false' value='true' " + delegation + "/>" +
            "</div>" +



            "<div class='col-md-1' style='padding-left: 3.5%;'>" +
            "<input type='checkbox' class='custom-check-box' id='OrganizationUsersList_" + signatoryEmailIndex + "__ESealSignatory' name='OrganizationUsersList[" + signatoryEmailIndex + "].ESealSignatory' onclick='return false' value='true' " + affixEseal + "/>" +
            "</div>" +
            "<div class='col-md-1' style='padding-left: 3.5%;'>" +
            "<input type='checkbox' class='custom-check-box' id='OrganizationUsersList_" + signatoryEmailIndex + "__ESealPrepatory' name='OrganizationUsersList[" + signatoryEmailIndex + "].ESealPrepatory' onclick='return false' value='true' " + prepatory + "/>" +
            "</div>" +

            "<div class='col-md-1' style='padding-left: 3.5%;'>" +
            "<input type='checkbox' class='custom-check-box' id='OrganizationUsersList_" + signatoryEmailIndex + "__Template' name='OrganizationUsersList[" + signatoryEmailIndex + "].Template' onclick='return false' value='true' " + prepatory + " hidden/>" +
            "<input type='checkbox' class='custom-check-box' id='OrganizationUsersList_" + signatoryEmailIndex + "__Bulksign' name='OrganizationUsersList[" + signatoryEmailIndex + "].Bulksign' onclick='return false' value='true' " + bulksigner + "/>" +
            "</div>" +

            "<div class='col-md-2' style='padding-left: 2%;'>" +
            "<input type='text' style='height:23px; padding-left: 5px;' class='form-control designationListInput' id='OrganizationUsersList_" + signatoryEmailIndex + "Designation' name='OrganizationUsersList[" + signatoryEmailIndex + "].Designation' value='" + designation + "'readonly='readonly'/>" +
            "</div>" +
            "<div class='col-md-1' style='padding-left: 2%;'>" +
            "<div class='form-group' style='display: flex;align-items: center;'>" +
            "<label for='OrganizationUsersList_" + signatoryEmailIndex + "' class='btn btn-info custom-file-upload'onclick='return false' style='height:23px;width:40px;margin-left:2px'>" +
            "<i class='fa fa-file'></i>" +
            "</label>" +
            "<i class='fa fa-check-circle fa-lg text-success' id='OrganizationUsersList_" + signatoryEmailIndex + "_check' style='display:" + isSignPhotoAvailable + "'></i>" +
            "<input type='file' class='form-control' /*onchange='encodeImageFileAsURL(this)'*/ /*onchange='FileToBase64(this)'*/ onclick='return false' id='OrganizationUsersList_" + signatoryEmailIndex + "' name='OrganizationUsersList[" + signatoryEmailIndex + "]' accept='.jpg, .png, .jpeg' hidden/>" +
            "<input type='text' class='form-control signatureFile' id='OrganizationUsersList_" + signatoryEmailIndex + "SignaturePhoto' name='OrganizationUsersList[" + signatoryEmailIndex + "].SignaturePhoto'  value='" + signaturePhoto + "'   hidden/>" +
            "</div>" +
            "</div>" +

            "<div class= 'col-md-1' style='padding-left: 5%;'>" +
            "<button class= 'btn btn-xs btn-primary liEditViewButton' type='button'  style='width: 50px; height: 25px;'>edit</button>" +
            "</div>" +


            "<div class='col-md-1' style='padding-left: 5%;'>" +
            "<button class='clearliSignatory' type='button' style='margin-left:8px'>x</button>" +
            "</div>" +

            "</li>";
        $('#signatory-email-list').append(li);
        signatoryEmailIndex++;
        $('#SignatoryEmail').val('');
        $('#addSignatoryEmailFieldset').show();
        $('#signatoryLable').show();
        $("span[data-valmsg-for='SignatoryEmail']").html('');

    }

</script>

<!-- Privileges Modal -->
<div class="modal fade" id="privilegesModal" tabindex="-1" aria-labelledby="privilegesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-sm">
            <div class="modal-header" style="padding: 0px 0px 18px 0px !important; border-bottom: 1px solid rgba(226, 232, 240, 1);align-items:end !important;">
                <h5 class="modal-title"
                    style="color: black; font-weight: 700 !important; font-size:16px !important; padding:0px !important;"
                    id="privilegesModalLabel">
                    Organization Privileges
                </h5>
                <img src="~/assets/images/CloseIcon.svg"
                     class="close-img"
                     data-dismiss="modal"
                     alt="Close"
                     style="cursor:pointer;" />
            </div>
            <div class="modal-body">
                <!-- Scrollable List Container -->
                <div class="privileges-container">
                </div>
            </div>
            @*<div class="modal-footer">
                    <button type="button" style="background-color: #fff; color: inherit;" class="btn btn-other" data-dismiss="modal">
                        Close
                    </button>
                </div>*@
        </div>
    </div>
</div>

<!-- Styles for Clean Privileges List -->
<style>
    .privileges-container {
        max-height: 300px; /* Adjust height as needed */
        overflow-y: auto;
        padding: 10px;
        display: flex;
        flex-direction: row;
        justify-content: space-around;
        gap: 20px;
    }

    .privileges-list {
        list-style-type: none; /* Remove bullet points */
        padding: 0;
        margin: 0;
    }

        .privileges-list li {
            padding: 8px 15px;
            font-size: 16px;
            background: #f8f9fa; /* Light grey background */
            margin-bottom: 6px;
            border-radius: 5px;
            text-align: left;
        }

            .privileges-list li:last-child {
                margin-bottom: 0;
            }

    .modal-content {
        border-radius: 16px !important;
        padding: 16px;
    }
</style>