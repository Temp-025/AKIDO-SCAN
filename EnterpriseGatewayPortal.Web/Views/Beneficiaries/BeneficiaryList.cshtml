@model EnterpriseGatewayPortal.Web.ViewModel.Beneficiaries.BeneficiaryListViewModel
@using EnterpriseGatewayPortal.Web.Models

@{
    ViewBag.Breadcrumb = new List<BreadCrumbModel>
{
        new BreadCrumbModel { Title = "Business - Beneficiaries",Url = "",IconKey = "beneficiaries"},
    };
}
@{
    var layoutType = Context.Request.Cookies["HeaderNavigationLayout"];
}
@{
    await Html.RenderPartialAsync("_AlertBox");
    var hasData = Model.BeneficiaryList != null && Model.BeneficiaryList.Count() > 0;
}
<style>
    .classshide {
        display: none !important;
    }

    .privileges-container {
        max-height: 300px;
        overflow-y: auto;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        gap: 20px;
    }

    .modal-content {
        border-radius: 16px !important;
        padding: 16px;
    }

    .card-box {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
    }

        .card-box:hover {
            background: rgba(249, 247, 237, 1);
            border: 1px solid #92722A;
        }

            .card-box:hover > .card-title {
                color: #92722A;
            }

    .card-icon.hover {
        display: none;
    }

    .card-box:hover .card-icon.normal {
        display: none;
    }

    .card-box:hover .card-icon.hover {
        display: inline;
    }


    .card-box {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        justify-content: center;
        width: 180px;
        height: 135px;
        padding: 16px;
        border: 1px solid #E2E8F0;
        border-radius: 16px;
    }

    .card-icon {
        height: 60px;
    }

    .card-title {
        font-family: "Roboto", sans-serif;
        font-weight: 500;
        font-size: 18px;
        line-height: 28px;
        color: #4B4F58;
    }

    .card-input {
        border: none;
        background: transparent;
        font-family: Roboto, sans-serif;
        font-weight: 500;
        font-size: 18px;
        line-height: 28px;
        color: #4B4F58;
        cursor: pointer;
        text-align: center;
        pointer-events: none;
    }

    .card-icon.hover {
        display: none;
    }

    .card-box:hover .card-icon.normal {
        display: none;
    }

    .card-box:hover .card-icon.hover {
        display: block;
    }

    .card-box:hover .card-input {
        color: #92722A;
    }
</style>

@*@if (Model == null || Model.BeneficiaryList.Count() == 0)
{
    <style>
        table {
            height: 70% !important;
        }

        .table-hover > tbody > tr:hover > td {
            background: none !important;
        }

        body {
            overflow: hidden;
        }

        .dataTables_wrapper {
            height: 100% !important;
        }

            .dataTables_wrapper > .row:nth-of-type(2) {
                height: 100% !important;
            }

        td:not([style*="display: none"]) {
            border-bottom-right-radius: 12px !important;
            border-bottom-left-radius: 12px !important;
        }
    </style>
}*@

<div class="classshide">
    <div id='viewer'></div>
</div>
<div class="row" style="height:100%;">
    <div class="col-md-12 plr">
        <div class="card-body">
            <div class="row align-items-center justify-content-between" style="padding-left: 15px; padding-right: 15px;">
                <!-- Left: Search bar (will be injected by DataTables) -->
                <div class="col-md-3 col-sm-12 d-flex align-items-center plr" id="custom-search-container"></div>

                <!-- Right: Buttons -->
                <div class="col-md-9 col-sm-12 plr text-right">
                    <div class="btn-group">

                        <a class="btn btn-other" asp-controller="Beneficiaries" asp-action="List">
                            <img src="~/assets/images/refresh.png"
                                 alt="refresh Icon"
                                 width="17" height="17"
                                 style=" margin-right: 7px; opacity: 1; position: relative; bottom: -2px;">Refresh
                        </a>
                    </div>
                    @*&nbsp;&nbsp;&nbsp;
                        <div class="btn-group">
                            <a class="btn btn-other" href="@Url.Action("DownloadCSV", "Beneficiaries")">
                                Download Template
                            </a>
                        </div>*@
                    &nbsp;&nbsp;&nbsp;
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary uaeid-primary dropdown-toggle" id="add-beneficiary-btn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="padding-top:2.5px; margin-right: 3px;">
                                <path d="M15.5 8C15.5 8.16576 15.4342 8.32473 15.3169 8.44194C15.1997 8.55915 15.0408 8.625 14.875 8.625H8.625V14.875C8.625 15.0408 8.55915 15.1997 8.44194 15.3169C8.32473 15.4342 8.16576 15.5 8 15.5C7.83424 15.5 7.67527 15.4342 7.55806 15.3169C7.44085 15.1997 7.375 15.0408 7.375 14.875V8.625H1.125C0.95924 8.625 0.800269 8.55915 0.683058 8.44194C0.565848 8.32473 0.5 8.16576 0.5 8C0.5 7.83424 0.565848 7.67527 0.683058 7.55806C0.800269 7.44085 0.95924 7.375 1.125 7.375H7.375V1.125C7.375 0.95924 7.44085 0.800269 7.55806 0.683058C7.67527 0.565848 7.83424 0.5 8 0.5C8.16576 0.5 8.32473 0.565848 8.44194 0.683058C8.55915 0.800269 8.625 0.95924 8.625 1.125V7.375H14.875C15.0408 7.375 15.1997 7.44085 15.3169 7.55806C15.4342 7.67527 15.5 7.83424 15.5 8Z" fill="white" />
                            </svg>
                            Add
                        </button>
                    </div>


                </div>
            </div>
            <table id="beneficiariesUserTable" class="table-striped table-bordered table-hover table-checkable order-column full-width table @(Model.BeneficiaryList == null || Model.BeneficiaryList.Count() == 0 ? "empty-table" : "")">
                <thead>
                    <tr>
                        @* <th hidden>Id</th>*@
                        <th>UAEID Email</th>
                        <th>NIN</th>
                        <th>Mobile Number</th>
                        <th>Passport</th>
                        <th>Status</th>

                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>

                    @if (Model.BeneficiaryList == null || Model.BeneficiaryList.Count() == 0)
                    {
                        <tr>
                            <td style="display: none;"></td>
                            <td style="text-align:center" valign="top" colspan="6" class="dataTables_empty">
                                <img class="NoRecordsCls" src="~/assets/images/No-Records-icon.svg" alt="No records" style=" display:block; margin:0 auto 8px;">
                                <p class="NoRecordFound-paragarph">No records found</p>
                                <p class="NoRecordTable-Text">Get started by clicking on 'Create'</p>
                            </td>

                            <td style="display: none;"></td>
                            <td style="display: none;"></td>
                            <td style="display: none;"></td>
                            <td style="display: none;"></td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var item in Model.BeneficiaryList)
                        {
                            <tr class="odd gradeX">
                                @*<td hidden>@item.Id</td>*@
                                <td>@(string.IsNullOrWhiteSpace(item.BeneficiaryUgpassEmail) ? "N/A" : item.BeneficiaryUgpassEmail)</td>
                                <td>@(string.IsNullOrWhiteSpace(item.BeneficiaryNin) ? "N/A" : item.BeneficiaryNin)</td>
                                <td>@(string.IsNullOrWhiteSpace(item.BeneficiaryMobileNumber) ? "N/A" : item.BeneficiaryMobileNumber)</td>
                                <td>@(string.IsNullOrWhiteSpace(item.BeneficiaryPassport) ? "N/A" : item.BeneficiaryPassport)</td>

                                <td>
                                    @if (string.IsNullOrWhiteSpace(item.Status))
                                    {
                                        <span class="status-tag status-na">N/A</span>
                                    }
                                    else
                                    {
                                        var status = item.Status.Trim().ToLower();
                                        var statusCapitalized = char.ToUpper(status[0]) + status.Substring(1);
                                        var cssClass = status switch
                                        {
                                            "active" => "status-tag status-active",
                                            "failed" => "status-tag status-failed",
                                            "In Progress" => "status-tag status-inprogress",
                                            _ => "status-tag status-na"
                                        };
                                        <span class="@cssClass">@statusCapitalized</span>
                                    }
                                </td>


                                <td class="valigntop">

                                    <div class="btn-group">
                                        <button class="btn btn-xs deepPink-bgcolor no-margin" type="button" data-toggle="dropdown"
                                                aria-expanded="false">
                                            Actions
                                            <i class="fa fa-angle-down"></i>
                                        </button>
                                        <ul class="dropdown-menu pull-left" role="menu">
                                            <li>
                                                <a asp-action="Edit" asp-route-id="@item.Id" onclick="document.getElementById('navigationNetworkOverlay').style.display='block'">
                                                    <img src="~/assets/images/Pencil-edit-icon.svg" alt="edit" style="position: relative;bottom: 1px;width: 18px;height: 18px;" />Edit
                                                </a>
                                            </li>

                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>

            </table>
        </div>
    </div>
</div>

@*Modal for Add action*@
<div class="modal fade" id="privilegesModal" tabindex="-1" aria-labelledby="privilegesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-sm">
            <div class="modal-header" style="padding: 0px 0px 18px 0px !important; border-bottom: 1px solid rgba(226, 232, 240, 1);align-items:end !important;">
                <h5 class="modal-title"
                    style="color: black; font-weight: 700 !important; font-size:16px !important; padding:0px !important;"
                    id="privilegesModalLabel">
                    Add Beneficiary
                </h5>
                <img src="~/assets/images/CloseIcon.svg"
                     class="close-img"
                     data-dismiss="modal"
                     alt="Close"
                     style="cursor:pointer;" />
            </div>
            <div class="modal-body">
                <!-- Scrollable List Container -->
                <div class="privileges-container">
                    <div class="card-box" onclick="newBeneficiary()">
                        <img src="~/assets/images/Add_User_Icon.svg" class="card-icon normal" />
                        <img src="~/assets/images/Add_User_Icon_Brown.svg" class="card-icon hover" />
                        <span class="card-title">Add Individual</span>
                    </div>

                    <label class="card-box" for="uploadCSV">
                        <img src="~/assets/images/Add_Using_CSV_Icon.svg" class="card-icon normal" />
                        <img src="~/assets/images/Add_Using_CSV_Brown.svg" class="card-icon hover" />
                        <span class="card-title">Add Using CSV</span>
                    </label>

                    <input type="file" id="uploadCSV" accept=".csv" hidden />

                </div>

                <!-- Note for CSV Upload -->
                @*<div class="mt-3 p-2" style="background:#F9FAFB; border:1px solid #E0E0E0; font-size:13px; color:#555;border-radius:8px;">
                        <strong>Note:</strong> Please download the template and use it to upload beneficiary details in CSV format.
                    </div>*@
            </div>
            <div class="modal-footer d-flex justify-content-end align-items-center" style="margin:0px !important;">
                <a class="btn btn-primary uaeid-primary" href="@Url.Action("DownloadCSV", "Beneficiaries")">
                    Download Sample CSV
                </a>
            </div>
        </div>
    </div>
</div>


<script>
    var allowedCSVFileTypes = ['.csv'];
    var emailRegex = /^([\w-\.]+)@@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/;
    var binaryRegex = /^[01]$/;
    var ninRegex = /^[A-Z0-9]{1,14}$/;
    var passportRegex = /^[A-Z0-9]{1,12}$/;
    var validData = true;

    $(document).ready(function () {
        document.getElementById("navigationNetworkOverlay").style.display = "none";
         $('#networkOverlay').hide();
        var layoutType = '@(layoutType ?? "")';
        if (layoutType == "Vertical") {
                $("#BusinessModule > a")
                    .attr("aria-expanded", "true")
                    .addClass("active");

                $("#BusinessModule")
                    .addClass("submenu-active show");

                $("#BusinessModule .submenu")
                    .addClass("show");

                $('#Beneficiaries').addClass('active');
                /*For Beadcrum Start*/
                $('#homeMenu').addClass('breadcrumb-item').append('Beneficiaries');
                $('#mainMenu').removeClass('breadcrumb-item');
                $('#subMenu').removeClass('breadcrumb-item');
        }

        var table = $("#beneficiariesUserTable").DataTable({
            "bLengthChange": false,
            "searching": true,
            "paging": @hasData.ToString().ToLower(),
            "info": @hasData.ToString().ToLower(),
            //  "dom": '<"top"f>rt<"bottom"ip><"clear">', // Keep 'f' for the search input only
            "initComplete": function () {
                // Move the search bar into our custom container
                $(".dataTables_filter").appendTo("#custom-search-container");
                $('.dataTables_filter input[type="search"]').attr('placeholder', 'Search');
                $('.dataTables_filter label').contents().filter(function () {
                    return this.nodeType === 3;
                }).remove();

            }

        });

        document.getElementById("uploadCSV").addEventListener("change", function () {
            if (this.files.length > 0) {
                $("#privilegesModal").modal("hide");
            }
        });


    });
        function newBeneficiary() {
        document.getElementById("navigationNetworkOverlay").style.display = "block";
        window.location.href = '@Url.Action("NewBeneficiary", "Beneficiaries")';
    }

    $('#add-beneficiary-btn').on('click', function () {
        //$('.privileges-container').empty();
        var modal = $('#privilegesModal');
        //var container = modal.find('.privileges-container');
        //var options = [
        //    { text: 'Add Individual', action: 'newBeneficiary' },
        //    { text: 'Add Using CSV', action: 'uploadCSV' }
        //];
        //options.forEach(function (option) {
        //    var item = $('<div class="privilege-item"></div>').text(option.text);
        //    item.on('click', function () {
        //        if (option.action === 'newBeneficiary') {
        //            newBeneficiary();
        //        } else if (option.action === 'uploadCSV') {
        //            $('#uploadCSV').click();
        //        }
        //        modal.modal('hide');
        //    });
        //    container.append(item);
        //});
        modal.modal('show');
    });

    $(document).on("change", '#uploadCSV', function () {

        var file = $(this).get(0).files[0];


        if (file == undefined) {
            fileName = "Choose File...";
        }
        else {
            fileName = file.name;
            var fileExtension = getExtension(file.name);
            if (allowedCSVFileTypes.includes(fileExtension)) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    var rows = e.target.result.split("\n");
                    var rawObject;
                    var CsvData = [];
                    var existingEmails = [];
                    var existingNINs = [];
                    var existingPassports = [];
                    var existingMobileNumbers = [];
                    var maxSize;

                    for (var i = 1; i < rows.length; i++) {
                        if (rows[i].trim() !== "") {
                            var cells = rows[i].split(",");

                            var ugpassEmail = cells[0];
                            var nin = cells[1];
                            var passportNumber = cells[2];
                            var mobNo = cells[3];
                            var sign_Permission = cells[4];
                            var user_Permission = cells[5];

                           // var signatureImage = cells[5];

                           if(ugpassEmail == null || ugpassEmail == ""){
                                $('#uploadCSV').val('');
                                return Swal.fire({ icon: 'error', title: "Mandatory", text: "Please enter UAEID email." });

                           }
                           if((sign_Permission == "" && user_Permission == "")||(sign_Permission == "0" && user_Permission == "0")){
                                $('#uploadCSV').val('');
                              return Swal.fire({ icon: 'error', title: "Mandatory", text: "please select atleast one Service for " + ugpassEmail });

                           }

                            if (existingEmails.includes(ugpassEmail) || existingNINs.includes(nin) || existingPassports.includes(passportNumber) || existingMobileNumbers.includes(mobNo)) {
                                $('#uploadCSV').val('');

                                return Swal.fire({ icon: 'error', title: "Duplicate Data", text: "Please ensure email, NIN, passport, and mobile numbers are unique." });

                            }


                            if (passportNumber == "" && mobNo == "" && nin == "" && ugpassEmail == "") {
                                $('#uploadCSV').val('');
                                return Swal.fire({ icon: 'error', title: "Invalid Data", text: "Please enter UAEID Email/ Mobile Number/ Passport Number/ Nin" });
                            }

                            //var stringLength = 0;
                            //if (cells.length != 1) {
                            //    if (signatureImage.includes("base64,")) {
                            //        var image = signatureImage.split("base64,")[1];
                            //        stringLength = image.length;
                            //    } else {
                            //        stringLength = signatureImage.length;
                            //    }
                            //}


                            //var sizeInBytes = 4 * Math.ceil((stringLength / 3)) * 0.5624896334383812;
                            //var sizeInKb = sizeInBytes / 1000;

                            //if (sizeInKb > maxSize) {
                            //    validData = false;
                            //    $('#uploadCSV').val('');
                            //    return Swal.fire({ type: 'error', title: "Max size exceeded", text: "Signature file must be less than 20 Kb for " + ugpassEmail });
                            //}

                            if (nin != "" && !ninRegex.test(nin)) {
                                validData = false;
                                $('#uploadCSV').val('');
                                return Swal.fire({ icon: 'error', title: "Invalid NIN Number", text: "Please enter a valid NIN number accepts A-Z(capital)&0-9 and max length is 14." });

                            }
                            if (passportNumber != "" && !passportRegex.test(passportNumber)) {
                                validData = false;
                                $('#uploadCSV').val('');
                                return Swal.fire({ icon: 'error', title: "Invalid Passport Number", text: "Please enter a valid passport number accepts A-Z(capital)&0-12 and max length is 12." });

                            }

                            if (ugpassEmail != "" && !emailRegex.test(ugpassEmail)) {
                                validData = false;
                                $('#uploadCSV').val('');
                                return Swal.fire({ icon: 'error', title: "Invalid Email", text: "Please enter a valid UAEID Email" });

                            }
                            if (mobNo != "" && mobNo != "") {
                                var newNumber = ValidateNumber(mobNo);
                                if (newNumber == null) {

                                    validData = false;
                                    $('#uploadCSV').val('');
                                    return Swal.fire({ icon: 'error', title: "Invalid Mobile Number", text: "Please enter a valid mobile number" });
                                    break;
                                }
                                mobNo = newNumber;
                            }


                            if (ugpassEmail.trim() != "") {
                                existingEmails.push(ugpassEmail);
                            }
                            if (passportNumber.trim() != "") {
                                existingPassports.push(passportNumber);
                            }
                            if (nin.trim() != "") {
                                existingNINs.push(nin);
                            }
                            if (mobNo.trim() != "") {
                                existingMobileNumbers.push(mobNo);
                            }

                            rawObject = {
                                UgpassEmail: cells[0],
                                NIN: cells[1],
                                PassportNumber: cells[2],
                                MobNo: mobNo,
                                //Designation: cells[4],

                                //SignatureImage: cells[5],

                                Signature_Permission: cells[4],
                                User_Permission: cells[5],
                                Signature_Validity_Flag: cells[6],
                                User_Validity_Flag: cells[7],

                                Signature_Valid_From: cells[8],
                                Signature_Valid_Upto: cells[9],

                                User_Valid_From: cells[10],
                                User_Valid_Upto: cells[11],

                                //Eseal_Permission: cells[10],
                                //Eseal_Validity_Flag: cells[11],
                                //Eseal_Valid_From: cells[12],
                                //Eseal_Valid_Upto: cells[13],

                            };

                            CsvData.push(rawObject);
                        }

                    }

                    var SponsorBeneficiaryList = {
                        BeneficiaryList: [],
                        //OrgId: OrganizationId,
                        //OrgName: OrganizationName,
                        CsvData: CsvData
                    };

                    $.ajax({
                        url: '@Url.Action("AddMultipleBeneficiariesUser", "Beneficiaries")',
                        type: 'POST',
                        cache: false,
                        contentType: 'application/json; charset=utf-8',
                        processData: false, // Don't process data (since we're sending JSON)
                        data: JSON.stringify(SponsorBeneficiaryList),
                        beforeSend: function () {
                            $('#overlay').show();
                        },
                        complete: function () {

                            $('#overlay').hide();
                        },
                        success: function (data) {
                            if (data.status == true) {
                                Swal.fire({
                                    icon: 'success',
                                    title: "Success",
                                    text: data.message
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = '@Url.Action("BeneficiaryList", "Beneficiaries")';
                                    }
                                });

                            }
                            if (data.status == false) {
                                Swal.fire({
                                    icon: 'error',
                                    title: "Add Beneficiary",
                                    text: data.message,
                                    showCancelButton: false
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                    }
                                });

                            }
                            $('#uploadCSV').val('');
                        }
                    });
                };
                reader.readAsText($("#uploadCSV")[0].files[0]);
            }
        }
    });

    function getExtension(filename) {
        return '.' + filename.split('.').pop().toLowerCase();
    }

    function ValidateNumber(MobNumber) {

        var MobNumber1 = MobNumber.replace("+256", "").replace("+91", "");

        if (/[^\d]+/.test(MobNumber1)) {
            return null; // Return null if MobNumber1 contains non-digit characters
        }
        if (MobNumber.startsWith("+256")) {
            if (MobNumber.length != 13) {
                return null;
            }
        } else if (MobNumber.startsWith("256")) {
            if (MobNumber.length != 12) {
                return null;
            }
            MobNumber = "+" + MobNumber;

        } else if (MobNumber.startsWith("+91")) {
            if (MobNumber.length != 13) {
                return null;
            }
        }
        else if (MobNumber.startsWith("91")) {
            if (MobNumber.length != 12) {
                return null;
            }
            MobNumber = "+" + MobNumber;
        }
        else if (MobNumber.startsWith("0")) {
            if (MobNumber.length == 10) {
                MobNumber = MobNumber.replace("0", "+256");
            }
            else if (MobNumber.length == 11) {
                MobNumber = MobNumber.replace("0", "+91");
            } else {
                return null;
            }
        }
        else if (MobNumber.length == 9) {
            MobNumber = "+256" + MobNumber;
        }

        else if (MobNumber.length == 10) {
            MobNumber = "+91" + MobNumber;
        }
        else {
            return Swal.fire({ icon: 'error', title: "mobile number", text: "Check your mobile number " });
        }

        return MobNumber
    }

</script>
