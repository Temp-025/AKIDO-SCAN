@model EnterpriseGatewayPortal.Web.ViewModel.DigitalForm.DocumentTemplateViewModel

@using System.Security.Claims
@using Newtonsoft.Json

@{
    Layout = "~/Views/Shared/_LayoutDigitalForms.cshtml";
}

@* <div style="display: flex; justify-content: flex-end;">
    <a class="btn btn-primary" asp-action="Index" asp-controller="DigitalForm" style="font-size: 15px;">
        <i class="fa fa-caret-left"></i> Back
    </a>
</div> *@

<div class="row">
    <div class="col-md-12">
        <div class="card-custom">
            <partial name="_AlertBox" />

            <div class="card-body">
                <div id='Viewer1' style='width: 1024px; height: 600px; margin: 0 auto;'></div>
            </div>
        </div>
    </div>
</div>


<script>

    // function base64ToBlob(base64) {
    //     const binaryString = window.atob(base64);
    //     const len = binaryString.length;
    //     const bytes = new Uint8Array(len);
    //     for (let i = 0; i < len; ++i) {
    //         bytes[i] = binaryString.charCodeAt(i);
    //     }
    //     return new Blob([bytes], { type: 'application/pdf' });
    // }

    // function handleSuccess(data) {
    //     webviwerInstance.UI.loadDocument(data, { filename: '@Model.DocumentName' });
    //     webviwerInstance.UI.setZoomLevel('100%');
    // }

    // function handleError(message) {
    //     swal({
    //         title: 'Error',
    //         text: message || 'Something went wrong!',
    //         type: 'error',
    //     }, function (isConfirm) {
    //         if (isConfirm) {
    //             window.location.href = '@Url.Action("Index", "DigitalForm")';
    //         }
    //     });
    // }

    // $(document).ready(function () {
    //     $('#digitalFormsMenu').addClass('active');
    //     $('#homeMenu').removeClass('breadcrumb-item').addClass('breadcrumb-item').append('Digital Forms > Preview');
    //     $('#mainMenu').removeClass('breadcrumb-item');
    //     $('#subMenu').removeClass('breadcrumb-item');

    //     var url = "@Url.Action("GetPreviewConfig", "DigitalForm")";
    //     var id = "@Model.EdmsId";

    //     $.ajax({
    //         url: url + '/' + id,
    //         type: 'GET',
    //         beforeSend: function () {
    //             $('#overlay').show();
    //         },
    //         complete: function () {
    //             $('#overlay').hide();
    //         },
    //         success: function (resp) {
    //             if (resp.success) {
    //                 var Documentbase64 = resp.resource;
    //                 var file = base64ToBlob(Documentbase64);
    //                 var name = "@Model.DocumentName"
    //                 var blob = getblob(file, name).then(handleSuccess).catch(handleError);
    //             } else {
    //                 handleError(resp.message);
    //             }
    //         },
    //         error: function (e) {
    //             console.log(e);
    //             handleError();
    //         }
    //     });
    // });

    function base64ToBlob(base64) {

        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; ++i) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return new Blob([bytes], { type: 'application/pdf' });
    }

    $(document).ready(function () {

        $('#digitalFormsMenu').addClass('active');
        $('#homeMenu').removeClass('breadcrumb-item');
        $('#homeMenu').addClass('breadcrumb-item').append('Digital Forms > Previvew ');
        $('#mainMenu').removeClass('breadcrumb-item');
        $('#subMenu').removeClass('breadcrumb-item');

        $('#overlay').show();

        var intervalId = "";
        intervalId = setInterval(function () {
            if (isWebViewerLoaded) {
                $('#overlay').hide();
                get();
                clearInterval(intervalId);
            }
        }, 3000);
    });

    function get() {

        var url = "@Url.Action("GetPreviewConfig", "DigitalForm")";
        var id = "@Model.EdmsId";

        $.ajax({
            url: url + '/' + id,
            type: 'GET',
            success: function (resp) {
                if (resp.success) {
                    var Documentbase64 = resp.resource;
                    //var file = base64ToBlob(Documentbase64);

                    webviwerInstance.UI.loadDocument(base64ToBlob(Documentbase64), { filename: 'Sample.pdf' });
                    const { Annotations, documentViewer, PDFNet, Tools, annotationManager } = webviwerInstance.Core

                    documentViewer.addEventListener('documentLoaded', () => {

                        webviwerInstance.UI.setZoomLevel("100%");
                        const zoom = webviwerInstance.UI.getZoomLevel("100%");
                        documentViewer.addEventListener('annotationsLoaded', () => {
                            annotationManager.getAnnotationsList().forEach(annot => {
                                annot.ReadOnly = true;
                            });
                        });

                    });
                } else {
                    Swal.fire({
                      title: 'Error',
                      text: resp.message,
                      icon: 'error',
                      confirmButtonText: 'OK'
                    }).then((result) => {
                      if (result.isConfirmed) {
                        window.location.href = '@Url.Action("Index", "DigitalForm")';
                      }
                    });

                }
            },
            error: function (e) {
               Swal.fire({
                  title: 'Error',
                  text: 'Something went wrong!',
                  icon: 'error',
                  confirmButtonText: 'OK'
                }).then((result) => {
                  if (result.isConfirmed) {
                    window.location.href = '@Url.Action("Index", "DigitalForm")';
                  }
                });

            }
        });

    }
</script>
