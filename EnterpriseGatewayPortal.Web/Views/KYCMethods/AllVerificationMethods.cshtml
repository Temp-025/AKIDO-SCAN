@model EnterpriseGatewayPortal.Web.ViewModel.KYCMethods.KycMethodViewModel
@using EnterpriseGatewayPortal.Web.Models

@{
    ViewBag.Breadcrumb = new List<BreadCrumbModel>
{
        new BreadCrumbModel { Title = "All Verification Methods", Url = "", IconKey = "payments-rateCards" }
    };
}

<style>
    body {
        font-family: 'Inter', sans-serif !important;
    }

    .search-input {
        width: 100%;
        max-width: 480px;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        transition: border-color 0.2s ease;
        margin-top: 0.5rem;
        margin-bottom: 1.5rem;
    }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

    .methods-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        justify-content: center;
    }

    .method-card {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

        .method-card:hover {
            box-shadow: 0 6px 14px rgba(0,0,0,0.08);
        }

        .method-card.hidden {
            display: none !important;
        }

    .method-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .method-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        word-wrap: break-word;
        overflow-wrap: anywhere;
        flex: 1;
    }

    .kyc-meta {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        font-weight: 500;
        align-items: center;
        gap: 20px;
        font-size: 1rem;
        color: #374151;
        margin: 0.75rem 0px;
    }

    .kyc-method-type {
        font-size: 1rem;
        color: black;
        font-weight: 500;
    }

    .badge {
        font-size: 0.85rem;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 600;
    }

    .badge-active {
        background-color: #dcfce7;
        color: #195f33;
    }

    .badge-inactive {
        background-color: #f3f4f6;
        color: #6b7280;
    }

    .view-details-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        font-size: 0.9rem;
        padding: 6px 10px;
        display: flex;
        align-items: center;
        gap: 5px;
        border-radius: 6px;
        font-weight: 600;
    }

    .method-info {
        margin-top: 1rem;
        font-size: 0.95rem;
        color: #374151;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .method-desc {
        margin-top: 0.8rem;
        color: #4b5563;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .method-tags {
        margin-top: 0.75rem;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .method-tag {
        border: 1px solid #e9e9e9;
        background: #F9F7ED;
        color: #92722A;
        font-weight: 600;
        font-size: 12px;
        padding: 2px 10px;
        border-radius: 8px;
    }

    .alert-info {
        text-align: center;
        font-size: 1rem;
        color: #6b7280;
        padding: 1rem;
        border-radius: 8px;
        background: #f3f4f6;
    }
</style>

<span class="sub-label" style="margin-bottom:0px !important;">All Available Verification Methods</span>
<div class="container py-4" style="margin:0px;max-width:100% !important;">
    <input type="text" id="methodSearch" class="search-input" placeholder="Search verification methods..." />

    @if (Model?.Methods != null && Model.Methods.Any())
    {
        <div class="methods-list" id="methodsList">
            @foreach (var method in Model.Methods)
            {
                <div class="method-card"
                     data-name="@method.MethodName.ToLower()"
                     data-type="@method.MethodType.ToLower()"
                     data-tags="@(string.Join(" ", method.TargetSegments?.Select(t => t.ToLower()) ?? new List<string>()))"
                     data-desc="@(method.Description?.ToLower() ?? "")">
                    <div class="method-header">
                        <div class="method-title">@method.MethodName</div>
                        @*<span class="badge @(method.Status.ToLower() == "active" ? "badge-active" : "badge-inactive")">
                            @($"{char.ToUpper(method.Status[0])}{method.Status.Substring(1).ToLower()}")
                        </span>*@
                    </div>

                    <button type="button"
                            class="btn btn-primary uaeid-primary view-details-btn"
                            data-methoduid="@method.MethodUid"
                            data-methodname="@method.MethodName"
                            data-pricing="@method.Pricing"
                            data-status="@method.Status"
                            data-description="@method.Description"
                            data-methodtype="@method.MethodType"
                            data-processingtime="@method.ProcessingTime"
                            data-confidencethreshold="@method.ConfidenceThreshold"
                            data-requeststatus="@method.RequestStatus"
                            data-isrequested="@method.IsRequested.ToString()"
                            data-targetsegments='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(method.TargetSegments ?? new List<string>()))'
                            data-mandatory='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(method.MandatoryAttributes ?? new List<string>()))'
                            data-optional='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(method.OptionalAttributes ?? new List<string>()))'>
                        <i class="ph ph-eye"></i> View Details
                    </button>

                    <div class="kyc-method-type">
                        @method.MethodType
                    </div>

                    <div class="kyc-meta">
                        <div class="d-flex justify-content-center align-items-center flex-row" style="gap:5px;">
                            <i class="ph ph-currency-dollar text-success"></i>
                            @method.Pricing AED
                        </div>
                        <div class="d-flex justify-content-center align-items-center flex-row" style="gap:5px;">
                            <i class="ph ph-clock text-primary"></i>
                            @($"{method.ProcessingTime}s SLA")
                        </div>
                        <div class="d-flex justify-content-center align-items-center flex-row" style="gap:5px;">
                            <i class="ph ph-shield-check text-info"></i>
                            @($"{method.ConfidenceThreshold}%") threshold
                        </div>
                    </div>

                    @if (method.TargetSegments != null && method.TargetSegments.Any())
                    {
                        <div class="method-tags">
                            @foreach (var tag in method.TargetSegments)
                            {
                                if (!string.IsNullOrWhiteSpace(tag))
                                {
                                    <span class="method-tag">@tag</span>
                                }
                            }
                        </div>
                    }

                    <div class="method-desc">@method.Description</div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert-info">
            No verification methods are currently available.
        </div>
    }
</div>

<script>
    $(document).ready(function () {
        $("#networkOverlay").hide();

        const searchInput = document.getElementById('methodSearch');
        const methodCards = document.querySelectorAll('.method-card');

        searchInput.addEventListener('input', function () {
            const query = this.value.trim().toLowerCase();

            methodCards.forEach(card => {
                const name = card.dataset.name || '';
                const type = card.dataset.type || '';
                const tags = card.dataset.tags || '';
                const desc = card.dataset.desc || '';

                const matches = name.includes(query) ||
                    type.includes(query) ||
                    tags.includes(query) ||
                    desc.includes(query);

                card.classList.toggle('hidden', !matches);
            });
        });
    });

    $(document).ready(function () {
        $("#networkOverlay").hide();

        $("#Kyc-Methods").addClass("active");

    });

    $(document).on("click", ".view-details-btn", function () {
        const parseJsonSafely = (dataAttr) => {
            try {
                return JSON.parse(dataAttr);
            } catch {
                return [];
            }
        };

        const data = {
            MethodUid: $(this).data("methoduid"),
            MethodName: $(this).data("methodname"),
            MethodType: $(this).data("methodtype"),
            Status: $(this).data("status"),
            Pricing: $(this).data("pricing"),
            Description: $(this).data("description"),
            ProcessingTime: $(this).data("processingtime"),
            ConfidenceThreshold: $(this).data("confidencethreshold"),
            RequestStatus: $(this).data("requeststatus"),
            TargetSegments: parseJsonSafely($(this).attr("data-targetsegments")),
            MandatoryAttributes: parseJsonSafely($(this).attr("data-mandatory")),
            OptionalAttributes: parseJsonSafely($(this).attr("data-optional")),
            IsRequested: $(this).data("isrequested")
        };

        showMethodDetails(data);
    });

    function showMethodDetails(method) {
        $("#method-uid").val(method.MethodUid || "—");
        $("#method-name").val(method.MethodName || "—");
        $("#method-type").val(method.MethodType || "—");
        $("#method-pricing").val(method.Pricing || "—");
        $("#method-processingtime").val(method.ProcessingTime || "—");
        $("#method-confidence").val(method.ConfidenceThreshold || "—");
        $("#method-description").text(method.Description || "—");

        const displayStatus = method.Status
            ? method.Status.charAt(0).toUpperCase() + method.Status.slice(1).toLowerCase()
            : "—";

        $("#method-status")
            .text(displayStatus)
            .removeClass("badge-success badge-secondary")
            .addClass(displayStatus.toLowerCase() === "active" ? "badge-success" : "badge-secondary");


        $("#method-requeststatus")
            .text(method.RequestStatus || "—")
            .removeClass("badge-info badge-secondary")
            .addClass(method.RequestStatus?.toUpperCase() === "ACTIVE" ? "badge-info" : "badge-secondary");

        const renderList = (elId, items) => {
            const $el = $("#" + elId);
            $el.empty();
            if (Array.isArray(items) && items.length) {
                items.forEach(i => $el.append(`<li class="kyc-modal-tag">${i}</li>`));
            } else {
                $el.append(`<li class='text-muted'>—</li>`);
            }
        };

        debugger;
        if (method.IsRequested === true || method.IsRequested === "true") {
            $("#viewMethodModal #method-status-btn").css("display", "block");
            $("#viewMethodModal #method-send-request-btn").css("display", "none");
        } else {
            $("#viewMethodModal #method-status-btn").css("display", "none");
            $("#viewMethodModal #method-send-request-btn").css("display", "block");
        }

        renderList("method-targetsegments", method.TargetSegments);
        renderList("method-mandatory", method.MandatoryAttributes);
        renderList("method-optional", method.OptionalAttributes);

        $("#viewMethodModal").modal("show");
    }

    function sendRequest(methodUid) {

    console.log("Method UID:", methodUid);

    @*if (isRequested === true) {
        ////window.location.href = '@Url.Action("VerificationMethodStatus", "KYCMethods")' + '?methodUid=' + methodUid;
        $("#viewMethodModal").show();
        return;
    }*@

    $('#networkOverlay').show();
    $.ajax({
        url: '@Url.Action("SubmitKYCMethodRequest", "KYCMethods")',
        type: 'POST',
        data: { methodUid: methodUid },
        cache: false,
        dataType: 'json',
        success: function (response) {
            Swal.fire({
                title: 'Request Sent',
                text: 'Verification Method request has been sent successfully.',
                icon: 'success',
                confirmButtonText: 'OK'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '@Url.Action("RequestVErificationMethod", "KYCMethods")';
                }
            })
            $('#networkOverlay').hide();
        },
        error: function (xhr, status, error) {
            Swal.fire({
                title: 'Error',
                text: 'An error occurred while sending the request. Please try again.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
            $('#networkOverlay').hide();
        }
    });
}

</script>

@await Html.PartialAsync("VerificationMethodDetailsModal")
