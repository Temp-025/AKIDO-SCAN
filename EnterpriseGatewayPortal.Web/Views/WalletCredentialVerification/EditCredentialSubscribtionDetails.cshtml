@model EnterpriseGatewayPortal.Web.ViewModel.Wallet.WalletConfigurationViewModel
@using Newtonsoft.Json
@using EnterpriseGatewayPortal.Web.Models
@{
    ViewBag.Breadcrumb = new List<BreadCrumbModel>
{
        new BreadCrumbModel { Title = "Wallet - Subscribed Credentials",Url = Url.Action("List","WalletCredentialVerification"), IconKey = "wallet-subscribedCredentials"},
        new BreadCrumbModel { Title = "Edit New Credential",Url = "", IconKey = "edit"},
    };
}
@{
    ViewData["Title"] = "Wallet Configuration";
}

<style>

    .custom-card {
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        background: #ffffff;
    }

    .custom-fieldset {
        border: none;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

        .custom-fieldset legend {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }

    .nested-fieldset {
        padding-left: 15px;
    }

    .form-check-label {
        font-weight: 500;
    }

    .custom-table th, .custom-table td {
        vertical-align: middle;
    }

    #emailDataTable_wrapper .dataTables_scrollBody,
    #attributeTable_wrapper .dataTables_scrollBody {
        overflow-x: auto;
        scrollbar-width: none; /* For Firefox */
    }

        #emailDataTable_wrapper .dataTables_scrollBody::-webkit-scrollbar,
        #attributeTable_wrapper .dataTables_scrollBody::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Edge */
        }

    .card-content {
        overflow-y: auto; /* Add overflow-y to enable vertical scrolling if needed */
        /* max-height: 645px;Add max-height to limit the height of the card content*/
    }

    .table-container {
        width: 100%;
        overflow-x: auto;
    }

    .table-container {
        background-color: white;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 24px;
        /* padding-top: 11px; */
        padding-left: 0px !important;
        padding-right: 37px;
        margin-top: -18px;
        /* padding-bottom: 33px; */
    }

    .container {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 10px;
    }

    .qwer {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
    }


    .step-label {
        position: absolute;
        bottom: -24px; /* Adjust this value to control the space between the circle and label */
        width: 100px; /* Set the width based on your design */
        text-align: center;
        white-space: nowrap; /* Prevent text from wrapping */
        font-size: 15px;
    }

    .container .steps {
        display: flex;
        width: 76%;
        align-items: center;
        justify-content: space-between;
        position: relative;
        margin: 8px 30px;
        height: 0px;
    }

    .steps .circle {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 35px;
        width: 35px;
        color: #999;
        background: #e0e0e0;
        /* border-radius: 50%; */
        border: 3px solid #e0e0e0;
        z-index: 1;
        transition: all 300ms ease;
        overflow: hidden;
    }

        .steps .circle img {
            height: 56%;
            width: 47%;
        }

        .steps .circle.active {
            border-color: #007BFF;
            color: white;
            background-color: #007BFF;
        }


    .steps .progress-bar {
        position: absolute;
        top: 0%;
        left: 3%;
        transform: translateY(-50%);
        height: 3px;
        width: 94%;
        background: #e0e0e0;
        z-index: 0;
    }

    .progress-bar .indicator {
        position: absolute;
        height: 100%;
        width: 0%;
        background: #007BFF;
        transition: all 300ms ease;
    }

    @@media (max-width: 900px) {
        .App:not(.is-in-desktop-only-mode) .Header, .App:not(.is-in-desktop-only-mode) .Header.Tools {
            height: 0 !important;
            visibility: hidden !important;
        }
    }

    .custom-group {
        display: flex;
        flex-direction: row;
        align-items: center;
        margin-bottom: 15px; /* Adjusts spacing between form groups */
    }

        .custom-group label {
            margin-right: 10px; /* Adjusts spacing between label and input */
            min-width: 120px; /* Set a fixed width for labels to align them vertically */
            text-align: right; /* Aligns the text of the labels */
        }

    .custom-input {
        flex: 1; /* Makes input take the remaining space */
        max-width: 70%; /* Adjusts the width of the input field */
    }

    .classshide {
        display: none !important;
    }

    .content {
        min-height: 84vh;
        transition: all 0.3s;
        height: 592px !important;
    }

    .dataTables_scrollHead {
        background: white;
        top: 0;
        z-index: 10;
    }

    .tree {
        list-style-type: none;
        padding-left: 0;
    }

        .tree label {
            cursor: pointer;
            font-weight: 500;
        }

    .nested {
        display: none;
        padding-left: 20px;
        border-left: 2px solid #007bff;
    }

    .tree input[type="checkbox"]:checked ~ .nested {
        display: block;
    }

    .formats-container {
        border: 1px solid #ccc; /* Border color */
        border-radius: 10px; /* Rounded corners */
        padding: 19px; /* Space inside the border */
        margin-top: 10px; /* Spacing above the container */
    }


    .highlight {
        animation: glow 1s ease-in-out infinite alternate;
    }

    #maincard {
        /* height: 74vh !important;
            max-height: 100vh; */ /* commented height & max-height (stepper removed) */
        overflow-y: auto; /* Enables scrolling if content overflows */
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: transparent transparent; /* Transparent thumb and track */
    }

        /* Hide scrollbar for Webkit browsers (Chrome, Safari, Edge) */
        #maincard::-webkit-scrollbar {
            width: 0px; /* Hide scrollbar */
            background: transparent; /* Transparent background */
        }

        /* Optional: Ensure scrolling still works */
        #maincard::-webkit-scrollbar-thumb {
            background: transparent; /* Fully transparent scrollbar */
        }

    .format-checkbox {
        width: 15px; /* Adjust checkbox size */
        height: 18px; /* Adjust checkbox size */
    }

    .form-check-label {
        font-size: 15px;
        margin-top: 6px; /* Adjust font size */
    }

    .form-check {
        margin-bottom: 10px; /* Space between checkboxes */
        display: flex;
        align-items: center;
        gap: 8px; /* Space between checkbox and label */
    }

    .table-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd; /* single clean border */
        border-radius: 12px; /* rounded corners */
        overflow-x: hidden; /* prevent horizontal scroll */
    }

        /* Table full width inside */
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        /* Sticky header */
        .table-container thead th {
            position: sticky;
            top: 0;
            background: #F5F5F5;
            z-index: 2;
            text-align: left;
            padding: 10px;
        }

        /* Table body cells */
        .table-container tbody td {
            padding: 10px;
        }

        /* Optional: subtle borders between rows */
        .table-container th,
        .table-container td {
            border-bottom: 1px solid #eee;
        }

        /* Remove border from last row */
        .table-container tbody tr:last-child td {
            border-bottom: none;
        }

    .scroll-wrapper {
        border: 1px solid #ddd;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 300px; /* total height */
    }

    .scroll-header {
        background: #F5F5F5;
        font-size: 14px !important;
        font-weight: 500;
        color: black;
        font-family: 'Inter';
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    .scroll-body {
        flex: 1; /* takes remaining space */
        overflow-y: auto;
    }

        .scroll-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }

        .scroll-body td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .scroll-body tr:last-child td {
            border-bottom: none;
        }

</style>
<link rel="stylesheet" href="~/css/KeyFrames.css"/>
<div class="classshide">
    <div id='viewer'></div>
</div>
<label class="sub-label">Edit New Credential</label>
<div class="row" id="spacingCss">
    <div class="col-md-12 plr">
        <div class="card shadow-lg" id="maincard">
            <div class="card-body">

                <!-- Selected Credential -->
                <div class="row" id="configurationdiv">
                    <div class="col-md-6 mx-auto">
                        <div class="form-group mb-4">
                            <span style="font-size:15px; font-weight:500; color:black;">Selected Credential</span>
                            <input type="text" class="form-control mt-2" id="credentialInput"
                                   value="@(Model?.CredentialName ?? "N/A")"
                                   readonly />
                        </div>

                        <div class="form-group">
                            <div style="display:flex; align-items:center; justify-content:flex-start;">
                                <span style="font-size:15px; font-weight:500; color:black;">Select Required Standards</span>
                                <i class="fa fa-info-circle text-primary ms-2"
                                   style="font-size: 16px; cursor: pointer; padding-left: 9px;"
                                   onclick="ViewConfigurationDetails()"
                                   title="Click to view configuration details"></i>
                            </div>
                            <div style="margin-top:10px;">
                                @if (Model?.Originalconfiguration != null && Model.Originalconfiguration.Any())
                                {
                                    var groupedFormats = Model.Originalconfiguration
                                    .Select(x => x.format)
                                    .Where(f => !string.IsNullOrEmpty(f))
                                    .Distinct();

                                    var selectedFormats = Model.Selectedconfiguration?
                                    .Select(x => x.format)
                                    .Where(f => !string.IsNullOrEmpty(f))
                                    .ToHashSet() ?? new HashSet<string?>();

                                    foreach (var format in groupedFormats)
                                    {
                                        var isChecked = selectedFormats.Contains(format) ? "checked" : "";
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input format-checkbox"
                                                   id="format_@format"
                                                   name="selectedFormats"
                                                   value="@format"
                                            @isChecked disabled />
                                            <label class="form-check-label" for="format_@format">@format</label>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-warning mt-2">No wallet configurations available.</div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Attributes -->
                <div class="row classshide" id="DataAttivutesDiv">
                    <div class="col-md-8 mx-auto">
                        <div class="table-responsive" style="max-height:350px;overflow-y:auto;">
                            <table id="attributeTable" class="table-striped custom-table table" style="border-collapse:separate !important; border:1px solid #E0E0E0;">
                                <thead>
                                    <tr>
                                        <th>Attribute</th>
                                        <th class="text-center">Display Name</th>
                                        <th class="text-center">Data Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var dataAttribute in Model.DataAttributes.Distinct())
                                    {
                                        <tr>
                                            <td>@dataAttribute.Attribute</td>
                                            <td class="text-center">@dataAttribute.DisplayName</td>
                                            <td class="text-center">
                                                @{
                                                    string dataTypeName = dataAttribute.DataType switch
                                                    {
                                                        1 => "Binary",
                                                        2 => "Boolean",
                                                        3 => "Integer",
                                                        4 => "String",
                                                        8 => "DateTime",
                                                        _ => "Unknown"
                                                    };
                                                }
                                                @dataTypeName
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Verifier Emails -->
                <div class="row classshide" id="emailDiv">
                    <div class="col-md-7">
                        <div class="table-responsive" style="max-height:300px; overflow-y:auto;">
                            <table id="emailDataTable" class="table-striped custom-table table" style="border-collapse:separate !important; border:1px solid #E0E0E0;margin:0px !important;">
                                <thead>
                                    <tr>
                                        <th>Verifier Emails</th>
                                        <th class="text-center"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var email in Model.BulkSignerEmails.bulkSignerList.Distinct())
                                    {
                                        var isChecked = Model.Selectedemails != null && Model.Selectedemails.Contains(email) ? "checked" : "";
                                        <tr>
                                            <td>@email</td>
                                            <td class="text-center">
                                                <label class="checkbox-primary checkbox-table">
                                                    <input type="checkbox" class="custom-check-box select-checkbox VerifierEmails" data-static="true" data-email="@email" @isChecked />
                                                </label>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="scroll-wrapper">
                            <!-- Fixed Heading -->
                            <div class="scroll-header">
                                Selected Verifier Emails
                            </div>

                            <!-- Scrollable Table -->
                            <div class="scroll-body">
                                <table class="table-hover" id="selected-emails">
                                    <tbody>
                                        @if (Model.Selectedemails != null && Model.Selectedemails.Any())
                                        {
                                            foreach (var email in Model.Selectedemails)
                                            {
                                                <tr data-static="true" data-email="@email"><td>@email</td></tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr><td class="text-muted">No Verifier Emails selected</td></tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                </div>

            </div>

            <!-- Footer Buttons -->
            <div style="padding-right:10px; margin-top:100px;">
                <div style="float:right;">
                    <div id="configuration" class="classshide">
                        <button type="button" id="backButton1" class="btn btn-other" style="margin-left:18px;">Back</button>
                        <button type="button" id="nextButton" class="btn btn-primary uaeid-primary greenButton" style="margin-left:18px; height:36px; width:79px; font-size:13px;">Next</button>
                    </div>
                    <div id="Attributes" class="classshide">
                        <button type="button" id="backButton2" class="btn btn-other" style="margin-left:18px; height:36px; width:79px; font-size:13px;">Back</button>
                        <button type="button" id="Continue" class="btn btn-primary uaeid-primary greenButton" style="margin-left:18px; height:36px; width:79px; font-size:13px;">Next</button>
                    </div>
                    <div id="VerifierEmail">
                        <button type="button" id="backbutton" class="btn btn-other" style="margin-left:18px; height:36px; width:79px; font-size:13px;">Back</button>
                        &nbsp;&nbsp;
                        <button class="btn btn-primary greenButton SubscribeCredential uaeid-primary" type="button" style="font-size:13px;">Update Verifier Emails</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>




<script>
    var id = "@Model.Id";
    var status = "@Model.status";
    var credentialId = "@(Model?.credentialId ?? "null")";
    var organizationId = "@(Model?.organizationId ?? "null")";
    var selectedConfigurationData = '@Html.Raw(JsonConvert.SerializeObject(Model.Originalconfiguration))';
    var steps = document.querySelectorAll('.steps .circle');
    var line = document.querySelector('.progress-bar .indicator');
    // Convert "null" string to actual null in JavaScript if needed
    credentialId = credentialId === "null" ? null : credentialId;
    organizationId = organizationId === "null" ? null : organizationId;

     const allEmails = '@Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.BulkSignerEmails.bulkSignerList.Distinct()))';
    const selectedEmails = '@Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Selectedemails ?? new List<string>()))';

    $(document).ready(function () {
            $("#Wallet-Manager > a")
            .attr("aria-expanded", "true")
            .addClass("active");

        $("#Wallet-Manager")
            .addClass("submenu-active show");

        $("#Wallet-Manager .submenu")
            .addClass("show");

        $('#Wallet-Subscriptions').addClass('active');
            $('#homeMenu').addClass('breadcrumb-item').append('Wallet > Edit Subscribe Credential');
            $('#mainMenu').removeClass('breadcrumb-item');
            $('#subMenu').removeClass('breadcrumb-item');
            $('#CredentialsVerifyMenu').addClass('active');
            document.getElementById("navigationNetworkOverlay").style.display = "none";
            $('#networkOverlay').hide();
            $('#DataAttivutesDiv').addClass("classshide");
            $('#Attributes').addClass("classshide");
            $('#configurationdiv').addClass("classshide");
            $('#configuration').addClass("classshide");
            $('#emailDiv').removeClass("classshide");
            $('#VerifierEmail').removeClass("classshide");
            $('#backbutton').addClass("classshide");
    });


    document.querySelectorAll('.format-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            const settingsIcon = document.getElementById('settings-icon');
            const viewConfigBtn = document.getElementById('view-config-btn');
            if (document.querySelectorAll('.format-checkbox:checked').length > 0) {
                settingsIcon.classList.add('highlight');
                viewConfigBtn.classList.add('highlight');
            } else {
                settingsIcon.classList.remove('highlight');
                viewConfigBtn.classList.remove('highlight');
            }
        });
    });


    const checkboxes = document.querySelectorAll(".attribute");
    const selectedAttributesList = document.getElementById("selectedAttributes");

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener("change", updateSelectedAttributes);
    });

    function updateSelectedAttributes() {
        const selectedAttributes = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.getAttribute("data-attribute"));

        selectedAttributesList.innerHTML = selectedAttributes.length > 0
            ? selectedAttributes.map(attr => `<li class="list-group-item">${attr}</li>`).join('')
            : '<li class="list-group-item text-muted">No attributes selected</li>';
    }

    const verifyerEmail = document.querySelectorAll(".VerifierEmails");
    const selectedEmailList = document.querySelector("#selected-emails tbody");


    verifyerEmail.forEach(checkbox => {
        checkbox.addEventListener("change", function () {
            var checked = $(this).prop("checked");
            updateSelectedEmails(this, checked);
        });
    });

    function updateSelectedEmails(checkbox, checked) {
           debugger;

         const tbody1 = selectedEmailList.querySelector("tbody") || selectedEmailList;

        // Find the checkbox that triggered the change
        const emailValue = checkbox.getAttribute("data-email"); // assuming 'checkbox' is the one just changed
        const staticValue = checkbox.getAttribute("data-static");

        // Only remove the matching static row if unchecked
        if (!checked) {
            //var found = Array.from(verifyerEmail).find(cb => cb.getAttribute("data-email") === email);

            const row = tbody1.querySelector(`tr[data-email='${emailValue}']`);
            if (row) row.remove();
        }

        const tbody = selectedEmailList.querySelector("tbody") || selectedEmailList;

        // Remove any row (static or dynamic) if its related checkbox is unchecked
        Array.from(tbody.querySelectorAll("tr[data-email]")).forEach(tr => {
            const email = tr.getAttribute("data-email") || tr.innerText.trim();
            const relatedCheckbox = Array.from(verifyerEmail).find(cb => cb.getAttribute("data-email") === email);

            if (relatedCheckbox && checked == false) {
                tr.remove();
            }
        });

        // Collect emails left after removal
        const existingEmails = Array.from(tbody.querySelectorAll("tr"))
            .map(tr => tr.getAttribute("data-email") || tr.innerText.trim());

        // Add new rows for checked emails not already in table
        Array.from(verifyerEmail)
            .filter(cb => cb.checked)
            .forEach(cb => {
                const email = cb.getAttribute("data-email");

                if (!existingEmails.includes(email)) {
                    const tr = document.createElement("tr");
                    tr.setAttribute("data-email", email);
                    tr.innerHTML = `<td style="padding:10px;">${email}</td>`;
                    tbody.appendChild(tr);
                }
            });

        // Show placeholder only if table is completely empty
        if (tbody.querySelectorAll("tr[data-email]").length === 0) {
            tbody.innerHTML =
                '<tr data-dynamic="true"><td class="text-muted" style="padding:10px;">No Verifier Emails selected</td></tr>';
        }
    }


        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });


    function updateProgressBar(step, color) {
        steps.forEach((stepElement, index) => {
            stepElement.classList[index < step ? 'add' : 'remove']('active');
        });

        var width = ((step - 1) / (steps.length - 1)) * 100;
        line.style.width = width + '%';
        line.style.background = color;
    }

    function updateCircleColors(step, color) {
        steps.forEach((stepElement, index) => {
            stepElement.style.borderColor = index < step ? color : '#e0e0e0';
            stepElement.style.color = index < step ? color : '#e0e0e0';
        });
    }

    $("#nextButton").on("click", function (e) {
        e.preventDefault(); // Prevent default action



        // Scroll smoothly to the top first, then update the progress bar
        $('#maincard').animate({ scrollTop: 0 }, 300, function () {
            // Once scrolling completes, update UI elements
            $('#DataAttivutesDiv').removeClass("classshide");
            $('#Attributes').removeClass("classshide");
            $('#configurationdiv').addClass("classshide");
            $('#configuration').addClass("classshide");
            $('#emailDiv').addClass("classshide");
            updateProgressBar(2, "#007BFF");
            updateCircleColors(2, "#007BFF");
        });
    });



    $("#Continue").on("click", function (e) {
        e.preventDefault(); // Prevent default action (if any)

        $('#maincard').animate({ scrollTop: 0 }, 300, function () {
            $('#DataAttivutesDiv').addClass("classshide");
            $('#Attributes').addClass("classshide");
            $('#configurationdiv').addClass("classshide");
            $('#configuration').addClass("classshide");
            $('#emailDiv').removeClass("classshide");
            $('#VerifierEmail').removeClass("classshide");
            updateProgressBar(3, "#007BFF");
            updateCircleColors(3, "#007BFF");
        });
    });

    $("#backButton2").on("click", function (e) {
        e.preventDefault(); // Prevent default action (if any)

        $('#maincard').animate({ scrollTop: 0 }, 300, function () {
            $('#DataAttivutesDiv').addClass("classshide");
            $('#Attributes').addClass("classshide");
            $('#configurationdiv').removeClass("classshide");
            $('#configuration').removeClass("classshide");
            $('#emailDiv').addClass("classshide");
            $('#VerifierEmail').addClass("classshide");
            updateProgressBar(1, "#007BFF");
            updateCircleColors(1, "#007BFF");
        });
    });

    $("#backbutton").on("click", function (e) {
        e.preventDefault(); // Prevent default action (if any)

        $('#maincard').animate({ scrollTop: 0 }, 300, function () {
            $('#DataAttivutesDiv').removeClass("classshide");
            $('#Attributes').removeClass("classshide");
            $('#configurationdiv').addClass("classshide");
            $('#configuration').addClass("classshide");
            $('#emailDiv').addClass("classshide");
            $('#VerifierEmail').addClass("classshide");
            updateProgressBar(2, "#007BFF");
            updateCircleColors(2, "#007BFF");
        });
    });

    function ViewCredentialDetails() {

        var dataToSend = { CredentialUId: credentialId };
        $.ajax({
            url: '@Url.Action("ViewCredentialDetails", "WalletCredentialVerification")',
            data: dataToSend,
            type: "GET",
            /*contentType: "json",*/
            error: ajaxErrorHandler,
            beforeSend: function () {
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                if (data != null) {
                    $('#modalDialogContentDiv').html(data);
                    $('#modalDialogDiv').modal('show');
                }
                else {
                    Swal.fire({ icon: 'error', title: "Error", text: "Failed to get payment info" });
                }
            },
            error: ajaxErrorHandler

        });
    }

    function ViewConfigurationDetails() {

        var dataToSend = { CredentialUId: credentialId };
        $.ajax({
            url: '@Url.Action("ViewWalletConfigurationDetails", "Wallet")',
            data: dataToSend,
            type: "GET",
            /*contentType: "json",*/
            error: ajaxErrorHandler,
            beforeSend: function () {
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                if (data != null) {
                    $('#modalDialogContentDiv').html(data);
                    $('#modalDialogDiv').modal('show');
                }
                else {
                    Swal.fire({ icon: 'error', title: "Error", text: "Failed to get payment info" });
                }
            },
            error: ajaxErrorHandler

        });
    }
    // Function to collect selected checkboxes and send data to controller
    $(".SubscribeCredential").on("click", function () {

        var selectedAttributes = [];
        var selectedEmails = [];
        var selectedConfigurations = [];

        // Collect all attributes from DataAttributes in the Model
        var allAttributes = '@Html.Raw(Json.Serialize(Model.DataAttributes.Distinct()))';
        // Iterate over each attribute in DataAttributes
        allAttributes.forEach(function (attribute) {
            var isChecked = $(`.select-checkbox[data-attribute='${attribute.displayName}']`).is(":checked");

            selectedAttributes.push({
                displayName: attribute.displayName,
                attribute: attribute.attribute,
                dataType: attribute.dataType,
                mandatory: isChecked
            });
        });

        $(".select-checkbox[data-email]:checked").each(function () {
            selectedEmails.push($(this).data("email"));
        });
        if (selectedEmails.length === 0) {

            Swal.fire({ icon: 'error', title: "Validation Error", text: "Please select at least one email before proceeding." });
            return;
        }

        // Collect selected configurations (Fixed Selection of Formats)
        $(".form-check-input:checked").each(function () {
            var format = $(this).val(); // Get the selected format
            var formatConfig = [];
            var bindingMethods = [];
            var supportedMethods = [];

            // Find all binding methods related to this format
            $(this).closest('.form-check').next('.nested-fieldset').find(".binding-checkbox:checked").each(function () {
                bindingMethods.push($(this).val());
            });

            // Find all supported methods related to this format
            $(this).closest('.form-check').next('.nested-fieldset').find(".supported-checkbox:checked").each(function () {
                supportedMethods.push($(this).val());
            });

            // Find all configuration entries matching this format
            var matchedConfigs = selectedConfigurationData.filter(function (item) {
                return item.format === format;
            });

            // Push matching config entries into formatConfig
            formatConfig = formatConfig.concat(matchedConfigs);

            // Append to final configuration list
            selectedConfigurations = selectedConfigurations.concat(formatConfig);
        });

        // Construct JSON object
        var verifyCredential = {
            credentialId: credentialId, // Placeholder (Ensure it's properly assigned)
            organizationId: organizationId, // Placeholder (Ensure it's properly assigned)
            attributes: selectedAttributes,
            configuration: selectedConfigurations,
            emails: selectedEmails,
            id: id,
            status:"@Model.status"
        };

        // AJAX Call to Controller
        $.ajax({
            url: '@Url.Action("UpdateCredentialVerificationRquest", "WalletCredentialVerification")',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(verifyCredential),
            beforeSend: function () {
                $('#overlay').show();
            },
            complete: function () {
                $('#overlay').hide();
            },
            success: function (data) {
                if (data.success) {
                $('#DataAttivutesDiv, #Attributes, #configurationdiv, #configuration').addClass("classshide");
                $('#emailDiv, #VerifierEmail').removeClass("classshide");

                window.scrollTo(0, 0);

                Swal.fire({
                    icon: 'success',
                    title: "Success",
                    text: data.message
                }).then(() => {
                    window.location.href = "@Url.Action("List", "WalletCredentialVerification")";
                });

            } else {
                Swal.fire({
                    icon: 'error',
                    title: "Error",
                    text: data.message
                }).then(() => {
                    window.location.href = "@Url.Action("List", "WalletCredentialVerification")";
                });
            }

            },
            error: ajaxErrorHandler
        });
    });

</script>


