@model EnterpriseGatewayPortal.Web.ViewModel.QrSubscribeCredential.QrSubscribeCredentialViewModel
@using Newtonsoft.Json
@using EnterpriseGatewayPortal.Web.Models

@{
    ViewData["Title"] = "Wallet Configuration";
    ViewBag.BreadCrumb = new List<BreadCrumbModel>
    {
        new BreadCrumbModel { Title = "Subscribed QR Credentials", Url = Url.Action("List", "QrSubscribeCredential"),IconKey="wallet-subscribedCredentials"},
        new BreadCrumbModel { Title = "Edit Subscribed QR Credential", Url = "#",IconKey = "edit"}
    };
}

<style>
    html, body {
        height: 100%; /* base requirement */
        margin: 0;
    }

    .custom-card {
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        background: #ffffff;
    }

    .custom-fieldset {
        border: none;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

        .custom-fieldset legend {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
        }

    .nested-fieldset {
        padding-left: 15px;
    }

    .form-check-label {
        font-weight: 500;
    }

    .custom-table th, .custom-table td {
        vertical-align: middle;
    }

    #emailDataTable_wrapper .dataTables_scrollBody,
    #attributeTable_wrapper .dataTables_scrollBody {
        overflow-x: auto;
        scrollbar-width: none; /* For Firefox */
    }

        #emailDataTable_wrapper .dataTables_scrollBody::-webkit-scrollbar,
        #attributeTable_wrapper .dataTables_scrollBody::-webkit-scrollbar {
            display: none; /* For Chrome, Safari, and Edge */
        }

    .card-content {
        overflow-y: auto; /* Add overflow-y to enable vertical scrolling if needed */
        /* max-height: 645px; /* Add max-height to limit the height of the card content */ */
    }

    .table-container {
        width: 100%;
        overflow-x: auto;
    }

    .table-container {
        background-color: white;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 24px;
        /* padding-top: 11px; */
        padding-left: 0px !important;
        padding-right: 37px;
        margin-top: -18px;
        /* padding-bottom: 33px; */
    }

    .container {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 10px;
    }

    .qwer {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
    }


    .step-label {
        position: absolute;
        bottom: -24px; /* Adjust this value to control the space between the circle and label */
        width: 100px; /* Set the width based on your design */
        text-align: center;
        white-space: nowrap; /* Prevent text from wrapping */
        font-size: 15px;
    }

    .container .steps {
        display: flex;
        width: 76%;
        align-items: center;
        justify-content: space-between;
        position: relative;
        margin: 8px 30px;
        height: 0px;
    }

    .steps .circle {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 35px;
        width: 35px;
        color: #999;
        background: #e0e0e0;
        /* border-radius: 50%; */
        border: 3px solid #e0e0e0;
        z-index: 1;
        transition: all 300ms ease;
        overflow: hidden;
    }

        .steps .circle img {
            height: 56%;
            width: 47%;
        }

        .steps .circle.active {
            border-color: #007BFF;
            color: white;
            background-color: #007BFF;
        }


    .steps .progress-bar {
        position: absolute;
        top: 0%;
        left: 3%;
        transform: translateY(-50%);
        height: 3px;
        width: 94%;
        background: #e0e0e0;
        z-index: 0;
    }

    .progress-bar .indicator {
        position: absolute;
        height: 100%;
        width: 0%;
        background: #007BFF;
        transition: all 300ms ease;
    }

    @@media (max-width: 900px) {
        .App:not(.is-in-desktop-only-mode) .Header, .App:not(.is-in-desktop-only-mode) .Header.Tools {
            height: 0 !important;
            visibility: hidden !important;
        }
    }

    .custom-group {
        display: flex;
        flex-direction: row;
        align-items: center;
        margin-bottom: 15px; /* Adjusts spacing between form groups */
    }

        .custom-group label {
            margin-right: 10px; /* Adjusts spacing between label and input */
            min-width: 120px; /* Set a fixed width for labels to align them vertically */
            text-align: right; /* Aligns the text of the labels */
        }

    .custom-input {
        flex: 1; /* Makes input take the remaining space */
        max-width: 70%; /* Adjusts the width of the input field */
    }

    .classshide {
        display: none !important;
    }

    .content {
        min-height: 84vh;
        transition: all 0.3s;
        height: 592px !important;
    }

    .dataTables_scrollHead {
        background: white;
        top: 0;
        z-index: 10;
    }

    .tree {
        list-style-type: none;
        padding-left: 0;
    }

        .tree label {
            cursor: pointer;
            font-weight: 500;
        }

    .nested {
        display: none;
        padding-left: 20px;
        border-left: 2px solid #007bff;
    }

    .tree input[type="checkbox"]:checked ~ .nested {
        display: block;
    }

    .formats-container {
        border: 1px solid #ccc; /* Border color */
        border-radius: 10px; /* Rounded corners */
        padding: 19px; /* Space inside the border */
        margin-top: 10px; /* Spacing above the container */
    }

    @@keyframes glow {
        0% {
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        50% {
            box-shadow: 0 0 20px rgba(0, 123, 255, 1);
        }

        100% {
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
    }

    .highlight {
        animation: glow 1s ease-in-out infinite alternate;
    }

    #maincard {
        height: 75vh !important;
        max-height: 100vh;
        overflow-y: auto; /* Enables scrolling if content overflows */
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: transparent transparent; /* Transparent thumb and track */
    }

        /* Hide scrollbar for Webkit browsers (Chrome, Safari, Edge) */
        #maincard::-webkit-scrollbar {
            width: 0px; /* Hide scrollbar */
            background: transparent; /* Transparent background */
        }

        /* Optional: Ensure scrolling still works */
        #maincard::-webkit-scrollbar-thumb {
            background: transparent; /* Fully transparent scrollbar */
        }

    .format-checkbox {
        width: 15px; /* Adjust checkbox size */
        height: 18px; /* Adjust checkbox size */
    }

    .form-check-label {
        font-size: 15px;
        margin-top: 6px; /* Adjust font size */
    }

    .form-check {
        margin-bottom: 10px; /* Space between checkboxes */
        display: flex;
        align-items: center;
        gap: 8px; /* Space between checkbox and label */
    }

    /*-----------------------------------------------------------------*/
    /* Container style */
    .checkbox-primary {
        display: inline-flex !important;
        align-items: center; /* Align vertically center */
        gap: 16px; /* Item spacing = 16px */
        cursor: pointer;
        position: relative;
        color: #232528;
        margin-top: 0.5rem;
        margin-bottom: 13px;
    }

    /* Checkbox itself */
    .custom-check-box {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 20px;
        height: 20px;
        border: 1px solid #CBA344;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
        position: relative;
        z-index: 2;
        transition: background-color 0.2s, border-color 0.2s;
    }

        /* Checkmark style */
        .custom-check-box:checked {
            background-color: #CBA344;
            border-color: #92722A;
        }

            .custom-check-box:checked::after {
                content: "✔";
                color: white;
                font-size: 14px;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -55%);
            }

    /* Hover effect (circle background) */
    .checkbox-primary::before {
        content: "";
        position: absolute;
        left: -7px;
        top: -7px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: transparent;
        z-index: 1;
        transition: background-color 0.2s ease-in-out;
    }

    .checkbox-table::before {
        left: -11.5px !important;
        top: -11.5px !important;
    }

    .checkbox-primary:hover::before {
        background-color: #F9F7ED;
    }

    .checkbox-primary input[type="checkbox"]:checked {
        background-color: #CBA344;
        border-color: #CBA344;
    }

    .scroll-table {
        max-height: 300px; 
        overflow-y: auto;
        border: 1px solid #E0E0E0;
        border-radius: 12px;

        scrollbar-width:none;
    }

    .scroll-table::-webkit-scrollbar{
        display:none;
    }

        /* Make headers sticky */
        .scroll-table thead th {
            position: sticky;
            top: 0;
            background-color: #F5F5F5;
            z-index: 20;
        }

        /* Common table look */
        .scroll-table table {
            width: 100%;
            border-collapse: collapse; /* remove the double border issue */
        }

        .scroll-table th,
        .scroll-table td {
            padding: 10px;
            border-bottom: 1px solid #E0E0E0;
        }

        /* Row hover effect (optional, both tables same) */
        .scroll-table tbody tr:hover {
            background-color: #f9f9f9;
        }



</style>
<div class="classshide">
    <div id='viewer'></div>
</div>
<div class="row" id="spacingCss">
    <div class="col-md-12">
        <div style="padding: 0px 24px 10px 24px;display:flex;flex-direction:row;justify-content:space-between;align-items:center;">
            <span style="font-size:16px;font-weight:500;color:black;">Edit Verifier Emails</span>
        </div>
        <div class="card shadow-lg" id="maincard">
            <div class="card-body">

                <div class="row" id="emailDiv">
                    <!-- Left Table -->
                    <div class="col-md-6">
                        <div class="scroll-table">
                            <table id="emailDataTable" class="table" style="margin:0px !important;">
                                <thead>
                                    <tr>
                                        <th>Verifier Emails</th>
                                        <th class="text-center"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var email in Model.BulkSignerEmails.bulkSignerList.Distinct())
                                    {
                                        var isChecked = Model.Selectedemails != null && Model.Selectedemails.Contains(email) ? "checked" : "";
                                        <tr>
                                            <td>@email</td>
                                            <td class="text-center">
                                                <label class="checkbox-primary checkbox-table">
                                                    <input type="checkbox"
                                                           class="custom-check-box select-checkbox VerifierEmails"
                                                           data-email="@email"
                                                           @(isChecked)>
                                                </label>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Right Table -->
                    <div class="col-md-6">
                        <div class="scroll-table">
                            <table id="selectedEmails" class="table" style="margin:0px !important;">
                                <thead>
                                    <tr>
                                        <th>Selected Verifier Emails</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.Selectedemails != null && Model.Selectedemails.Any())
                                    {
                                        foreach (var email in Model.Selectedemails)
                                        {
                                            <tr data-email="@email" >
                                                <td style="padding:15px 8px !important;">@email</td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td class="text-muted">No Verifier Emails selected</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


                <div style="padding-right: 16px;margin-top:20px;">
                    <div style="float: right;">


                        <div id="VerifierEmail">

                            <button class="btn btn-primary uaeid-primary greenButton SubscribeCredential" type="button" style="height: 36px;width: 183px; font-size: 13px;">Update QR Credential</button>
                            @*<button class="btn btn-primary uaeid-primary greenButton SubscribeCredential" type="button" style="height: 36px;width: 183px; font-size: 13px;">Update QR Credential</button>*@

                        </div>
                    </div>

                </div>

            </div>

        </div>
    </div>

</div>





<script>
	var id = "@Model.id";
	var status = "@Model.status";
	var credentialId = "@(Model?.credentialId ?? "null")";
	var organizationId = "@(Model?.organizationId ?? "null")";
	var attributes = @Html.Raw(Json.Serialize(Model.attributes));
	var steps = document.querySelectorAll('.steps .circle');
	var line = document.querySelector('.progress-bar .indicator');
	// Convert "null" string to actual null in JavaScript if needed
	credentialId = credentialId === "null" ? null : credentialId;
	organizationId = organizationId === "null" ? null : organizationId;

	$(document).ready(function () {
        $('#networkOverlay').hide();
        document.getElementById("navigationNetworkOverlay").style.display = "none";

        $("#QR-Manager > a")
            .attr("aria-expanded", "true")
            .addClass("active");

        $("#QR-Manager")
            .addClass("submenu-active show");

        $("#QR-Manager .submenu")
            .addClass("show");

        $('#QR-Subscriptions').addClass('active');

        const parentNavItem = document.querySelector(`[data-section="QRM"] .nav-link`);
        if (parentNavItem) {
            parentNavItem.classList.add("active");
        }

		//var QrLink = document.getElementById('QRverificationModle').querySelector('.nav-link');
        //QrLink.click();

		$('#homeMenu').addClass('breadcrumb-item').append('Qr Verification > Subscribed QR Credentials > Edit');
		$('#mainMenu').removeClass('breadcrumb-item');
		$('#subMenu').removeClass('breadcrumb-item');
        $('#QrSubscribeCredentialsMenu').addClass('active');


	});



	document.querySelectorAll('.format-checkbox').forEach(checkbox => {
		checkbox.addEventListener('change', function () {
			const settingsIcon = document.getElementById('settings-icon');
			const viewConfigBtn = document.getElementById('view-config-btn');
			if (document.querySelectorAll('.format-checkbox:checked').length > 0) {
				settingsIcon.classList.add('highlight');
				viewConfigBtn.classList.add('highlight');
			} else {
				settingsIcon.classList.remove('highlight');
				viewConfigBtn.classList.remove('highlight');
			}
		});
	});




	const verifyerEmail = document.querySelectorAll(".VerifierEmails");
    const selectedEmailTableBody = document.querySelector("#selectedEmails tbody");

    verifyerEmail.forEach(checkbox => {
        checkbox.addEventListener("change", function () {
            updateSelectedEmails();
        });
    });

    function updateSelectedEmails() {
        const selectedEmailTableBody = document.querySelector("#selectedEmails tbody");

        verifyerEmail.forEach(cb => {
            const email = cb.getAttribute("data-email");
            const existingRow = selectedEmailTableBody.querySelector(`tr[data-email="${email}"]`);

            if (cb.checked && !existingRow) {
                // Add new row if checked and not already there
                const row = document.createElement("tr");
                row.setAttribute("data-email", email);
                row.innerHTML = `<td style="padding:15px 8px !important;">${email}</td>`;
                selectedEmailTableBody.appendChild(row);

                // Remove "no selection" placeholder if exists
                const placeholder = selectedEmailTableBody.querySelector(".text-muted");
                if (placeholder) placeholder.parentElement.remove();
            }
            else if (!cb.checked && existingRow) {
                // Remove row if unchecked
                existingRow.remove();
            }
        });

        // If nothing left → show placeholder
        if (selectedEmailTableBody.children.length === 0) {
            selectedEmailTableBody.innerHTML = `<tr><td class="text-muted">No Verifier Emails selected</td></tr>`;
        }
    }


	var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
	var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
		return new bootstrap.Tooltip(tooltipTriggerEl);
	});




	function ViewCredentialDetails() {

		var dataToSend = { CredentialUId: credentialId };
		$.ajax({
			url: '@Url.Action("ViewCredentialDetails", "WalletCredentialVerification")',
			data: dataToSend,
			type: "GET",
			/*contentType: "json",*/
			error: ajaxErrorHandler,
			beforeSend: function () {
				$('#overlay').show();
			},
			complete: function () {
				$('#overlay').hide();
			},
			success: function (data) {
				if (data != null) {
					$('#modalDialogContentDiv').html(data);
					$('#modalDialogDiv').modal('show');
				}
				else {
                    Swal.fire({ icon: 'error', title: "Error", text: "Failed to get payment info" });
				}
			},
			error: ajaxErrorHandler

		});
	}

	function ViewConfigurationDetails() {

		var dataToSend = { CredentialUId: credentialId };
		$.ajax({
			url: '@Url.Action("ViewWalletConfigurationDetails", "Wallet")',
			data: dataToSend,
			type: "GET",
			/*contentType: "json",*/
			error: ajaxErrorHandler,
			beforeSend: function () {
				$('#overlay').show();
			},
			complete: function () {
				$('#overlay').hide();
			},
			success: function (data) {
				if (data != null) {
					$('#modalDialogContentDiv').html(data);
					$('#modalDialogDiv').modal('show');
				}
				else {
					Swal.fire({ icon: 'error', title: "Error", text: "Failed to get payment info" });
				}
			},
			error: ajaxErrorHandler

		});
	}
	// Function to collect selected checkboxes and send data to controller
	$(".SubscribeCredential").on("click", function () {

		var selectedAttributes = [];
		var selectedEmails = [];
		var selectedConfigurations = [];



		// Collect selected emails
		$(".select-checkbox[data-email]:checked").each(function () {
			selectedEmails.push($(this).data("email"));
		});
		if (selectedEmails.length === 0) {

			Swal.fire({ icon: 'error', title: "Validation Error", text: "Please select at least one email before proceeding." });
			return; // Stop the process
		}

		// Construct JSON object
		var verifyCredential = {
			credentialId: credentialId, // Placeholder (Ensure it's properly assigned)
			organizationId: organizationId, // Placeholder (Ensure it's properly assigned)
			attributes: attributes,

			emails: selectedEmails,
			id: id,
			status: status,
		};

		// AJAX Call to Controller
		$.ajax({
			url: '@Url.Action("UpdateCredentialVerificationRquest", "QrSubscribeCredential")',
			type: 'POST',
			contentType: 'application/json',
			data: JSON.stringify(verifyCredential),
			beforeSend: function () {
				$('#overlay').show();
			},
			complete: function () {
				$('#overlay').hide();
			},
			success: function (data) {
				if (data.success) {

					window.scrollTo(0, 0);

					Swal.fire({
						icon: 'success',
						title: "Success",
						text: data.message,
						showCancelButton: false,
						confirmButtonText: "OK"
					}).then((result) => {
						if (result.isConfirmed) {
							window.location.href = "@Url.Action("List", "QrSubscribeCredential")";
						}
					});

				} else {

					Swal.fire({
						icon: 'error',
						title: "Error",
						text: data.message,
						showCancelButton: false,
						confirmButtonText: "OK"
					}).then((result) => {
						if (result.isConfirmed) {
							window.location.href = "@Url.Action("List", "QrSubscribeCredential")";
						}
					});

				}

			},
			error: ajaxErrorHandler
		});
	});

</script>