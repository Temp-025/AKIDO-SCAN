@model IEnumerable<EnterpriseGatewayPortal.Web.ViewModel.Wallet.CredentialsListViewModel>
@using EnterpriseGatewayPortal.Web.Models

@{
    ViewBag.Breadcrumb = new List<BreadCrumbModel>
{
        new BreadCrumbModel { Title = "Wallet - Credentials",Url = "", IconKey="wallet-credentials"},
    };
}

@{
    ViewData["Title"] = "Wallet";
}

@{
    await Html.RenderPartialAsync("_AlertBox");
}
@{
    var hasData = Model != null && Model.Count() > 0;
}
<script>
    Swal = Swal.mixin({
        customClass: {
            popup: 'custom-swal-popup',
            title: 'custom-swal-title',
            htmlContainer: 'custom-swal-content',
            confirmButton: 'custom-swal-confirm-btn',
            cancelButton: 'custom-swal-cancel-btn'
        },
        buttonsStyling: false
    });

    Swal.fire = function (options) {
        if (typeof options === "string") {
            options = { title: options };
        }

        const type = options.icon || options.type || "info";
        let iconHtml = "";

        switch (type) {
            case "info":
                iconHtml = '<img src="@Url.Content("~/assets/images/Info.svg")" class="custom-swal-icon">';
                break;
            case "warning":
                iconHtml = '<img src="@Url.Content("~/assets/images/warning.svg")" class="custom-swal-icon">';
                break;
            case "error":
                iconHtml = '<img src="@Url.Content("~/assets/images/Error.svg")" class="custom-swal-icon">';
                break;
            case "success":
                iconHtml = '<img src="@Url.Content("~/assets/images/Success.svg")" class="custom-swal-icon">';
                break;
            default:
                iconHtml = "";
        }

        options.iconHtml = iconHtml;
        options.icon = undefined;

        return originalSwalFire.call(this, options);
    };

</script>

<style>
    .classshide {
        display: none !important;
    }
</style>

@if (Model == null || Model.Count() == 0)
{
    <style>
        table {
            height: 70% !important;
        }

        .table-hover > tbody > tr:hover > td {           
            background: none !important;
        }

        body{
            overflow: hidden;
        }

        /* Apply 100% height to all DataTables wrappers */
        .dataTables_wrapper {
            height: 100% !important;
        }

            /* Apply 100% height only to the second .row inside any DataTables wrapper */
            .dataTables_wrapper > .row:nth-of-type(2) {
                height: 100% !important;
            }

        td:not([style*="display: none"]) {
            border-bottom-right-radius: 12px !important;
            border-bottom-left-radius: 12px !important;
        }

    </style>
}

<div class="row" style="height:100%;">
    <div class="col-md-12 plr">
        @*<div class="card">  *@
            <div class="card-body">


                <div class="row align-items-center justify-content-between" style="padding-left: 15px; padding-right: 15px;">
                    <!-- Left: Search bar (will be injected by DataTables) -->
                    <div class="col-md-6 col-sm-12 d-flex align-items-center plr" id="custom-search-container"></div>

                    <!-- Right: Buttons -->
                    <div class="col-md-6 col-sm-12 plr text-right">
                        <div class="btn-group">
                            <a class="btn btn-other" asp-action="Index">
                                <img src="~/assets/images/refresh.png"
                                     alt="refresh Icon"
                                     width="17" height="17"
                                     style=" margin-right: 7px; opacity: 1; position: relative; bottom: -2px;">Refresh
                            </a>
                        </div>
                        &nbsp;&nbsp;&nbsp;
                        <div class="btn-group">
                            <a id="addRow1" class="btn btn-primary uaeid-primary" onclick="AddButton()">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="padding-top:2.5px; margin-right: 3px;">
                                    <path d="M15.5 8C15.5 8.16576 15.4342 8.32473 15.3169 8.44194C15.1997 8.55915 15.0408 8.625 14.875 8.625H8.625V14.875C8.625 15.0408 8.55915 15.1997 8.44194 15.3169C8.32473 15.4342 8.16576 15.5 8 15.5C7.83424 15.5 7.67527 15.4342 7.55806 15.3169C7.44085 15.1997 7.375 15.0408 7.375 14.875V8.625H1.125C0.95924 8.625 0.800269 8.55915 0.683058 8.44194C0.565848 8.32473 0.5 8.16576 0.5 8C0.5 7.83424 0.565848 7.67527 0.683058 7.55806C0.800269 7.44085 0.95924 7.375 1.125 7.375H7.375V1.125C7.375 0.95924 7.44085 0.800269 7.55806 0.683058C7.67527 0.565848 7.83424 0.5 8 0.5C8.16576 0.5 8.32473 0.565848 8.44194 0.683058C8.55915 0.800269 8.625 0.95924 8.625 1.125V7.375H14.875C15.0408 7.375 15.1997 7.44085 15.3169 7.55806C15.4342 7.67527 15.5 7.83424 15.5 8Z" fill="white" />
                                </svg>Create
                            </a>
                        </div>

                    </div>
                </div>
                <table id="WalletTable" class="table-striped table-bordered table-hover table-checkable order-column full-width table @(Model == null || !Model.Any() ? "empty-table" : "")">
                    <thead>
                        <tr>
                        <td style="display: none;">Id</td>
                        <th>Credential Name</th>
                            @*  <th>ID Document</th> *@
                            <th>Authentication Scheme</th>
                            <th>Created Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model == null || Model.Count() == 0)
                        {
                        <tr>
                            <td style="display: none;"></td>
                            <td style="text-align:center" valign="top" colspan="6" class="dataTables_empty">
                                <img class="NoRecordsCls" src="~/assets/images/No-Records-icon.svg" alt="No records" style=" display:block; margin:0 auto 8px;">
                                <p class="NoRecordFound-paragarph">No records found</p>
                                <p class="NoRecordTable-Text">Get started by clicking on 'Create'</p>
                            </td>
                           
                            <td style="display: none;"></td>
                            <td style="display: none;"></td>
                            <td style="display: none;"></td>
                            <td style="display: none;"></td>
                        </tr>

                        }
                        else
                        {
                            @foreach (var item in Model)
                            {
                                <tr class="odd gradeX">
                                    <td hidden>@item.Id</td>
                                    <td>@item.DisplayName</td>
                                    @* <td>@item.VerificationDocType</td> *@
                                    <td>@item.AuthenticationScheme</td>
                                    <td>@item.CreatedDate.ToString("dd/MM/yyyy")</td>
                                    @* <td>@item.Status</td> *@
                                    <td>
                                        @if (string.IsNullOrWhiteSpace(item.Status))
                                        {
                                            <span class="status-tag status-na">N/A</span>
                                        }
                                        else
                                        {
                                        var status = item.Status.Trim().ToLower();
                                        var statusCapitalized = char.ToUpper(status[0]) + status.Substring(1);
                                        var cssClass = status switch
                                        {
                                            "active" => "status-tag status-active",
                                            "failed" => "status-tag status-failed",
                                            "In Progress" => "status-tag status-inprogress",
                                            _ => "status-tag status-na"
                                        };
                                        <span class="@cssClass">@statusCapitalized</span>
                                        }
                                    </td>
                                    <td class="valigntop">

                                        <div class="btn-group">
                                            <button class="btn btn-xs deepPink-bgcolor no-margin" type="button" data-toggle="dropdown"
                                                    aria-expanded="false">
                                                Actions
                                                <i class="fa fa-angle-down"></i>
                                            </button>
                                            <ul class="dropdown-menu pull-left" role="menu">

                                                @if (item.Status == "APPROVAL_REQUIRED" || item.Status == "ACTIVE")
                                                {

                                                    <li class="table-dropdown-li">
                                                        <a asp-action="ViewCredentialDetails" asp-route-id="@item.CredentialUId" onclick="document.getElementById('navigationNetworkOverlay').style.display='block'">
                                                            <img src="~/assets/images/Eye_View_Icon.svg" alt="edit" style="position: relative;bottom: 1px;width: 18px;height: 18px;" />View
                                                        </a>
                                                    </li>
                                                }
                                                @if (item.Status == "PENDING" || item.Status == "CONSENT_REQUIRED")
                                                {

                                                    <li class="table-dropdown-li">
                                                        <a asp-action="Edit" asp-route-uid="@item.CredentialUId" onclick="document.getElementById('navigationNetworkOverlay').style.display='block'">
                                                            <img src="~/assets/images/Pencil-edit-icon.svg" alt="edit" style="position: relative;bottom: 1px;width: 18px;height: 18px;" />Edit
                                                        </a>
                                                    </li>
                                                    @if (item.Status == "PENDING")
                                                    {

                                                        <li class="table-dropdown-li">
                                                            <a asp-action="TestCredential" asp-route-CredentialUid="@item.CredentialUId" onclick="document.getElementById('navigationNetworkOverlay').style.display='block'">
                                                                <img src="~/assets/images/PaperPlaneTilt.svg" alt="edit" style="position: relative;bottom: 1px;width: 18px;height: 18px;" />Send for Activation
                                                            </a>
                                                        </li>
                                                    }
                                                    @if (item.Status == "CONSENT_REQUIRED")
                                                    {


                                                        <li class="table-dropdown-li">
                                                            <a asp-action="ViewCredentialDetailsPDFView" asp-route-id="@item.CredentialUId" onclick="document.getElementById('navigationNetworkOverlay').style.display='block'">
                                                                <img src="~/assets/images/Pencil-edit-icon.svg" alt="edit" style="position: relative;bottom: 1px;width: 18px;height: 18px;" />Send for Activation
                                                            </a>
                                                        </li>
                                                    }
                                                }


                                            </ul>
                                        </div>

                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
       @* </div>*@
    </div>
</div>
<div class="classshide">
    <div id='viewer'></div>
</div>
@section scripts {
    <script>
        var walletCertificateStatus = @Json.Serialize(ViewBag.WalletCertificateStatus);
      
        $(document).ready(function () {
            $('#networkOverlay').hide();
            document.getElementById("navigationNetworkOverlay").style.display = "none";

            $("#Wallet-Manager > a")
                .attr("aria-expanded", "true")
                .addClass("active");

            $("#Wallet-Manager")
                .addClass("submenu-active show");

            $("#Wallet-Manager .submenu")
                .addClass("show");

            $('#Wallet-Credentials').addClass('active');

            $('#homeMenu').addClass('breadcrumb-item').append('Wallet > Wallet Credential');
            $('#mainMenu').removeClass('breadcrumb-item');
            $('#subMenu').removeClass('breadcrumb-item');
            $('#CredentialsMenu').addClass('active');
            //$('#navigationNetworkOverlay').css('display', 'none');

            var table = $("#WalletTable").DataTable({
                "bLengthChange": false,
                "searching": true,
                 "ordering": false,
                 "paging": @hasData.ToString().ToLower(),
                 "info": @hasData.ToString().ToLower(),
                //  "dom": '<"top"f>rt<"bottom"ip><"clear">', // Keep 'f' for the search input only
                "initComplete": function () {
                    // Move the search bar into our custom container
                    $(".dataTables_filter").appendTo("#custom-search-container");
                    $('.dataTables_filter input[type="search"]').attr('placeholder', 'Search');
                    $('.dataTables_filter label').contents().filter(function () {
                        return this.nodeType === 3;
                    }).remove();

                }

            });

        });

        // $("#AddButton").click(function () {
        //     if (walletCertificateStatus) {
        //         document.getElementById("navigationNetworkOverlay").style.display = "block";
        //         window.location.href = "@Url.Action("Add", "Wallet")";
        //     } else {

        //         Swal.fire({ icon: 'error', title: "Access Denied", text: "You are not authorized to create a Credential.Please contact the UAEID Admin." });
        //     }
        // });

        function AddButton() {
            if (walletCertificateStatus) {
                document.getElementById("navigationNetworkOverlay").style.display = "block";
                window.location.href = "@Url.Action("Add", "Wallet")";

          } else {
                Swal.fire({
                    icon: 'error',
                    title: "Access Denied",
                    text: "You are not authorized to create a Credential. Please contact the UAEID Admin.",
                    buttonsStyling: false
                });
          }
        }


        function TestCredential(CredentialId, DocumentType) {
            Swal.fire({
                title:'Enter ' + DocumentType + ' ID',
                input: 'text',
                inputPlaceholder: 'Your Document ID',
                showCancelButton: true,
                confirmButtonText: 'Submit',
                cancelButtonText: 'Cancel',
                inputAttributes: {
                    'aria-label': 'Document ID'
                }
            })
        .then((result) => {
                if (result.isConfirmed) {
                    const inputValue = result.value;
                    var testCredentialRequestDTO = {

                        UserId: inputValue,
                        CredentialId: CredentialId,

                    };


                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("TestCredential", "Wallet")',
                        data: JSON.stringify(testCredentialRequestDTO),
                        contentType: "application/json",
                        beforeSend: function () {
                            $('#overlay').show();
                        },
                        complete: function () {

                            $('#overlay').hide();
                        },
                        success: function (data) {

                            if (data.success == true) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Test Credential',
                                    text: data.message,
                                    showCancelButton: false
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.reload();
                                    }
                                });
                            }

                            if (data.success == false) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Test Credential',
                                    text: data.message,
                                    showCancelButton: false
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.reload();
                                    }
                                });
                            }

                        },
                        error: ajaxErrorHandler
                    });
                }
            });
        }

    </script>
}
